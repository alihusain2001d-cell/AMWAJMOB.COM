<script>
async function sendData(){

  const data = {
    name: document.getElementById("name").value.trim(),
    phone: document.getElementById("phone").value.trim(),
    invoice: document.getElementById("invoice").value.trim(),
    type: document.getElementById("type").value,
    start: document.getElementById("start").value
  };

  if(!data.name || !data.phone || !data.invoice || !data.start){
    alert("ุงูุฑุฌุงุก ุฅุฏุฎุงู ุฌููุน ุงูุญููู");
    return;
  }

  // =========================
  // 1๏ธโฃ ููุน ุชูุฑุงุฑ ุฑูู ุงููุงุชูุฑุฉ
  // =========================
  const SHEET =
   "https://docs.google.com/spreadsheets/d/1BiV0ZxQN_ClD1tA7w8W5rfmY1bXfs9oax7Q3oqeXq38/export?format=csv";

  const res = await fetch(SHEET);
  const csv = await res.text();

  // ูููู ุงูุจูุงูุงุช
  const lines = csv.trim().split("\n").map(r => r.split(","));
  const headers = lines.shift();   // ุงูุตู ุงูุฃูู ุนูุงููู
  const rows = lines.map(r => {
     let obj = {};
     headers.forEach((h,i)=> obj[h] = r[i]);
     return obj;
  });

  const exists = rows.find(r => r.invoice == data.invoice);

  if(exists){
    alert("โ ูุฐุง ุฑูู ุงููุงุชูุฑุฉ ููุณุฌูู ูุณุจูุงู โ ูุง ูููู ุชูุนูู ุงูุถูุงู ูุฑุชูู");
    return;
  }

  // =========================
  // 2๏ธโฃ ุญุณุงุจ ุชุงุฑูุฎ ุงูุงูุชูุงุก
  // =========================
  let days = data.type === "screen" ? 30 : 365;

  const startDate = new Date(data.start);
  const expiry = new Date(startDate);
  expiry.setDate(expiry.getDate() + days);

  data.expiry = expiry.toISOString().slice(0,10);

  alert("โ ุชู ุชูุนูู ุงูุถูุงู ุจูุฌุงุญ");

  // =========================
  // 3๏ธโฃ ุฅุฑุณุงู ุงูุจูุงูุงุช ููุฌุฏูู
  // =========================
  fetch("https://eo9txe5hkh3d1yk.m.pipedream.net",{
    method:"POST",
    headers:{"Content-Type":"application/json"},
    body:JSON.stringify(data)
  })
  .catch(()=> alert("ุญุฏุซ ุฎุทุฃ โ ุญุงูู ูุฑุฉ ุฃุฎุฑู"));

  // =========================
  // 4๏ธโฃ ุฑุณุงูุฉ ูุงุชุณุงุจ ููุฒุจูู
  // =========================
  const msg =
`ุดูุฑุงู ูุดุฑุงุฆู ูู ุงููุงุฌ ููุฅููุชุฑูููุงุช ๐

ุชู ุชูุนูู ุถูุงูู ุจูุฌุงุญ โ

ููุงุณุชุนูุงู ุนู ุงูุถูุงู ุงุถุบุท ููุง:
https://www.amwajmob.com/index.html`;

  let phone = data.phone.replace(/^0/, "");
  const wa = `https://wa.me/964${phone}?text=${encodeURIComponent(msg)}`;

  window.open(wa, "_blank");
}
</script>
