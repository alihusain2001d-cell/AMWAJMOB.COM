<!DOCTYPE html>
<html lang="ar">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>ØªÙØ¹ÙŠÙ„ Ø¶Ù…Ø§Ù† Ø£Ù…ÙˆØ§Ø¬</title>

<style>
body{
  font-family: sans-serif;
  padding:15px;
  background:#f4f8fb;
  color:#0a2d3e;
  line-height:1.8;
  font-size:18px;
}
.container{
  max-width:450px;margin:auto;
  background:white;
  padding:18px;
  border-radius:14px;
  box-shadow:0 10px 22px rgba(0,0,0,.08);
}
header{text-align:center;margin-bottom:15px;}
header img{width:120px;margin-bottom:10px;}

label{font-weight:bold}
input,select,button{
  width:100%;padding:9px;
  margin:6px 0 14px;
  border-radius:8px;
  border:1px solid #cfd8dc;
}
button{
  background:#00a8cc;
  color:#fff;border:none;
  font-size:18px;
}
.notice{
  margin-top:15px;
  padding:10px;
  background:#e8f7ff;
  border-radius:10px;
}
.timer{
  background:#e3f2fd;
  margin-top:8px;
  padding:10px;
  border-radius:10px;
}
.whatsapp{margin-top:15px;text-align:center;}
.whatsapp a{
  display:inline-block;
  background:#25d366;
  color:white;
  padding:10px 14px;
  border-radius:10px;
  text-decoration:none;
}
.searchBox{
  margin-top:22px;
  padding:12px;
  background:#f9fafc;
  border-radius:12px;
}
</style>
</head>

<body>
<div class="container">

<header>
  <img src="1633875906547.jpg">
  <h3>ØªÙØ¹ÙŠÙ„ Ø¶Ù…Ø§Ù† Ø£Ù…ÙˆØ§Ø¬</h3>
</header>

<label>Ø§Ù„Ø¥Ø³Ù…</label>
<input id="name">

<label>Ø±Ù‚Ù… Ø§Ù„Ù‡Ø§ØªÙ</label>
<input id="phone" type="text">

<label>Ø±Ù‚Ù… Ø§Ù„ÙØ§ØªÙˆØ±Ø©</label>
<input id="invoice" type="text">

<label>Ù†ÙˆØ¹ Ø§Ù„Ù‚Ø·Ø¹Ø©</label>
<select id="type">
  <option value="">Ø§Ø®ØªØ±</option>
  <option value="screen">Ø´Ø§Ø´Ø©</option>
  <option value="battery">Ø¨Ø·Ø§Ø±ÙŠØ©</option>
</select>

<label>ØªØ§Ø±ÙŠØ® Ø§Ù„ØªØ±ÙƒÙŠØ¨</label>
<input id="start" type="date">

<button onclick="activate()">ØªÙØ¹ÙŠÙ„ Ø§Ù„Ø¶Ù…Ø§Ù†</button>

<div id="result" class="notice" style="display:none"></div>

<div class="searchBox">
  <h4>ğŸ” Ø¥Ø³ØªØ¹Ù„Ø§Ù… Ø§Ù„Ø¶Ù…Ø§Ù† Ø¨Ø±Ù‚Ù… Ø§Ù„ÙØ§ØªÙˆØ±Ø©</h4>
  <input id="searchInv" placeholder="Ø£Ø¯Ø®Ù„ Ø±Ù‚Ù… Ø§Ù„ÙØ§ØªÙˆØ±Ø©">
  <button onclick="searchInvoice()">Ø¨Ø­Ø«</button>
  <div id="searchResult"></div>
</div>

<div class="whatsapp">
  <a href="https://wa.me/9647709000160" target="_blank">
    ØªÙˆØ§ØµÙ„ ÙˆØ§ØªØ³Ø§Ø¨: 07709000160
  </a>
</div>

<p style="text-align:center;margin-top:18px">
  Ø´ÙƒØ±Ø§Ù‹ Ù„Ø§Ø®ØªÙŠØ§Ø±ÙƒÙ… Ø£Ù…ÙˆØ§Ø¬ ğŸŒŠ
</p>

<script>

// âœ”ï¸ Ø¬Ø¯ÙˆÙ„Ùƒ
const SHEET_ID = "1BiV0ZxQN_ClD1tA7w8W5rfmY1bXfs9oax7Q3oqeXq38";
const GID = "0";

// Ù‚Ø±Ø§Ø¡Ø© CSV Ù„Ù„Ø¨Ø­Ø« ÙˆÙ…Ù†Ø¹ Ø§Ù„ØªÙƒØ±Ø§Ø±
const CSV_URL = `https://docs.google.com/spreadsheets/d/${SHEET_ID}/export?format=csv&gid=${GID}`;

// Webhook
const WEBHOOK = "https://eo9txe5hkh3d1yk.m.pipedream.net";

async function getSheetRows(){
  const r = await fetch(CSV_URL);
  return (await r.text())
    .split("\n")
    .map(r=>r.split(","));
}

async function activate(){

  const data = {
    name: name.value.trim(),
    phone: phone.value.trim(),
    invoice: invoice.value.trim(),
    type: type.value,
    start: start.value
  };

  if(!data.name || !data.phone || !data.invoice || !data.type || !data.start){
    alert("Ø§Ù„Ø±Ø¬Ø§Ø¡ Ø¥Ø¯Ø®Ø§Ù„ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø­Ù‚ÙˆÙ„");
    return;
  }

  // Ù…Ù†Ø¹ ØªÙƒØ±Ø§Ø± Ø§Ù„ÙØ§ØªÙˆØ±Ø©
  const rows = await getSheetRows();
  if(rows.some(r => r[0] == data.invoice)){
    alert("âš ï¸ Ø±Ù‚Ù… Ø§Ù„ÙØ§ØªÙˆØ±Ø© Ù…Ø³Ø¬Ù„ Ù…Ø³Ø¨Ù‚Ø§Ù‹ â€” Ù„Ø§ ÙŠÙ…ÙƒÙ† Ø§Ù„ØªÙƒØ±Ø§Ø±");
    return;
  }

  // Ø­Ø³Ø§Ø¨ Ø§Ù†ØªÙ‡Ø§Ø¡ Ø§Ù„Ø¶Ù…Ø§Ù†
  const s = new Date(data.start);
  let expiry = new Date(s);
  expiry.setDate(s.getDate() + (data.type==="screen" ? 30 : 365));
  data.expiry = expiry.toISOString().slice(0,10);

  // Ø¥Ø±Ø³Ø§Ù„ Ù„Ù„Ø¬Ø¯ÙˆÙ„
  fetch(WEBHOOK,{
    method:"POST",
    headers:{ "Content-Type":"application/json" },
    body:JSON.stringify(data)
  })
  .then(()=> showResult(data))
  .catch(()=> alert("Ø­Ø¯Ø« Ø®Ø·Ø£ â€” Ø­Ø§ÙˆÙ„ Ù…Ø±Ø© Ø£Ø®Ø±Ù‰"));
}

function showResult(d){
  const exp = new Date(d.expiry);
  const box = document.getElementById("result");
  box.style.display="block";
  box.innerHTML =
    `âœ”ï¸ ØªÙ… ØªÙØ¹ÙŠÙ„ Ø§Ù„Ø¶Ù…Ø§Ù†<br>
     ØªØ§Ø±ÙŠØ® Ø§Ù„ØªÙØ¹ÙŠÙ„: ${d.start}<br>
     ØªØ§Ø±ÙŠØ® Ø§Ù„Ø§Ù†ØªÙ‡Ø§Ø¡: ${d.expiry}
     <div class="timer" id="timer"></div>`;

  setInterval(()=>{
    const now = new Date();
    let diff = exp - now;
    if(diff < 0){ document.getElementById("timer").innerHTML = "Ø§Ù†ØªÙ‡Ù‰ Ø§Ù„Ø¶Ù…Ø§Ù†"; return;}
    let days = Math.floor(diff/(1000*60*60*24));
    document.getElementById("timer").innerHTML =
      "Ø§Ù„ÙˆÙ‚Øª Ø§Ù„Ù…ØªØ¨Ù‚ÙŠ: " + days + " ÙŠÙˆÙ…";
  },1000);
}

// Ø§Ù„Ø¨Ø­Ø« Ø¨Ø±Ù‚Ù… Ø§Ù„ÙØ§ØªÙˆØ±Ø©
async function searchInvoice(){
  const inv = searchInv.value.trim();
  if(!inv){ alert("Ø£Ø¯Ø®Ù„ Ø±Ù‚Ù… Ø§Ù„ÙØ§ØªÙˆØ±Ø©"); return; }

  const rows = await getSheetRows();
  const row = rows.find(r=>r[0]==inv);

  if(!row){
    searchResult.innerHTML = "âŒ ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯";
    return;
  }

  searchResult.innerHTML =
    `Ø§Ù„Ø§Ø³Ù…: ${row[1]}<br>
     Ø§Ù„Ù‡Ø§ØªÙ: ${row[2]}<br>
     Ø§Ù„Ù†ÙˆØ¹: ${row[3]}<br>
     ØªØ§Ø±ÙŠØ® Ø§Ù„ØªØ±ÙƒÙŠØ¨: ${row[4]}<br>
     ØªØ§Ø±ÙŠØ® Ø§Ù„Ø§Ù†ØªÙ‡Ø§Ø¡: ${row[5]}`;
}

</script>
</div>
</body>
</html>
