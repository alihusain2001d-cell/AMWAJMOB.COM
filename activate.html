<script>
const SHEET =
 "https://docs.google.com/spreadsheets/d/1BiV0ZxQN_CID1tA7w8W5rfmY1bXfs9oax7Q3oqeXq38/export?format=csv";

async function getRows() {
  const res = await fetch(SHEET);
  const text = await res.text();
  const lines = text.trim().split("\n").map(r => r.split(","));
  const headers = lines.shift();

  return lines.map(r => {
    let o = {};
    headers.forEach((h,i)=>o[h]=r[i]);
    return o;
  });
}

async function sendData(){

  // Ø¬Ù…Ø¹ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª
  const data = {
    name: document.getElementById("name").value.trim(),
    phone: document.getElementById("phone").value.trim(),
    invoice: document.getElementById("invoice").value.trim(),
    type: document.getElementById("type").value,
    start: document.getElementById("start").value
  };

  if(!data.name || !data.phone || !data.invoice || !data.start){
    alert("Ø§Ù„Ø±Ø¬Ø§Ø¡ Ø¥Ø¯Ø®Ø§Ù„ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø­Ù‚ÙˆÙ„");
    return;
  }

  // âŒ Ù…Ù†Ø¹ ØªÙƒØ±Ø§Ø± Ø±Ù‚Ù… Ø§Ù„ÙØ§ØªÙˆØ±Ø©
  const rows = await getRows();
  const exists = rows.find(r => r.invoice == data.invoice);
  if(exists){
    alert("âš  Ù‡Ø°Ø§ Ø±Ù‚Ù… Ø§Ù„ÙØ§ØªÙˆØ±Ø© Ù…Ø³Ø¬Ù„ Ù…Ø³Ø¨Ù‚Ø§Ù‹");
    return;
  }

  // Ø­Ø³Ø§Ø¨ Ø§Ù„Ø¶Ù…Ø§Ù†
  let days = data.type === "screen" ? 30 : 365;
  const startDate = new Date(data.start);
  const expiry = new Date(startDate);
  expiry.setDate(expiry.getDate() + days);

  data.expiry = expiry.toISOString().slice(0,10);

  // Ø§Ø¸Ù‡Ø§Ø± Ù†ØªÙŠØ¬Ø© Ù„Ù„Ù…Ø³ØªØ®Ø¯Ù…
  document.getElementById("result").style.display="block";
  document.getElementById("result").innerHTML =
    `ØªÙ… ØªÙØ¹ÙŠÙ„ Ø§Ù„Ø¶Ù…Ø§Ù† Ø¨Ù†Ø¬Ø§Ø­ â­<br>
     ØªØ§Ø±ÙŠØ® Ø§Ù„ØªÙØ¹ÙŠÙ„: <b>${data.start}</b><br>
     Ø§Ù†ØªÙ‡Ø§Ø¡ Ø§Ù„Ø¶Ù…Ø§Ù†: <b>${data.expiry}</b>
     <div id="timer" class="timer-box"></div>`;

  // Ø¹Ø¯Ø§Ø¯
  setInterval(()=>{
    const diff = expiry - new Date();
    if(diff<=0){ document.getElementById("timer").innerHTML="Ø§Ù†ØªÙ‡Ù‰ Ø§Ù„Ø¶Ù…Ø§Ù†"; return; }
    document.getElementById("timer").innerHTML =
      "Ø§Ù„ÙˆÙ‚Øª Ø§Ù„Ù…ØªØ¨Ù‚ÙŠ: " + Math.floor(diff/(1000*60*60*24)) + " ÙŠÙˆÙ…";
  },1000);

  // Ø§Ø±Ø³Ø§Ù„ Ù„Ù„Ø¬Ø¯ÙˆÙ„ (Pipedream)
  fetch("https://eo9txe5hkh3d1yk.m.pipedream.net",{
    method:"POST",
    headers:{ "Content-Type":"application/json" },
    body:JSON.stringify(data)
  });

  // Ø±Ø³Ø§Ù„Ø© ÙˆØ§ØªØ³Ø§Ø¨ Ù„Ù„Ø²Ø¨ÙˆÙ†
  let msg =
`Ø´ÙƒØ±Ø§Ù‹ Ù„Ø´Ø±Ø§Ø¦Ùƒ Ù…Ù† Ø£Ù…ÙˆØ§Ø¬ Ù„Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠØ§Øª ğŸŒŠ
ØªÙ… ØªÙØ¹ÙŠÙ„ Ø¶Ù…Ø§Ù†Ùƒ Ø¨Ù†Ø¬Ø§Ø­ âœ”

Ø±Ù‚Ù… Ø§Ù„ÙØ§ØªÙˆØ±Ø©: ${data.invoice}
Ù†ÙˆØ¹ Ø§Ù„Ù‚Ø·Ø¹Ø©: ${data.type}
ØªØ§Ø±ÙŠØ® Ø§Ù„Ø§Ù†ØªÙ‡Ø§Ø¡: ${data.expiry}

Ù„Ù„Ø§Ø³ØªØ¹Ù„Ø§Ù… Ø¹Ù† Ø§Ù„Ø¶Ù…Ø§Ù†:
https://www.amwajmob.com/index.html`;

  window.open(`https://wa.me/964${data.phone.slice(1)}?text=${encodeURIComponent(msg)}`);
}
</script>
