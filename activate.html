<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
<meta charset="UTF-8" />
<title>ضمان أمواج</title>
<meta name="viewport" content="width=device-width, initial-scale=1">

<style>
body{
  font-family:sans-serif;
  padding:20px;
  background:linear-gradient(135deg,#e6f6ff,#cfefff,#e6f6ff);
}
.container{
  max-width:540px;margin:auto;background:#fff;
  padding:18px;border-radius:16px;
  box-shadow:0 12px 28px rgba(0,0,0,.08);
}
.logo{text-align:center;margin-bottom:12px}
.logo img{width:135px}

.tabs{display:flex;margin:6px 0 14px;}
.tab{
  flex:1;text-align:center;padding:9px;
  border-radius:10px;cursor:pointer;
  background:#e9f2ff;font-weight:bold;
}
.tab.active{background:#1e88e5;color:#fff}

.section{display:none}
.section.active{display:block}

label{font-weight:bold;font-size:15px}
input,select,button{
  width:100%;padding:9px;margin:6px 0 14px;
  border-radius:10px;border:1px solid #ccd6e6;
}
button{background:#1e88e5;color:#fff;border:none}

.result{
  background:#e8f4ff;padding:12px;border-radius:10px;
  display:none;font-size:15px
}
.timer-box{
  background:#f5fbf2;border:1px solid #d6efcb;
  padding:9px;border-radius:10px;margin-top:10px
}
.whatsapp{
  background:#25D366;color:#fff;padding:11px;
  display:block;text-align:center;
  border-radius:8px;text-decoration:none;
  margin-top:14px
}
</style>
</head>

<body>

<div class="container">

<div class="logo">
  <img src="1633875906547.jpg">
</div>

<div class="tabs">
  <div id="tab1" class="tab active" onclick="showTab(1)">تفعيل الضمان</div>
  <div id="tab2" class="tab" onclick="showTab(2)">التحقق من الضمان</div>
</div>

<!-- تفعيل -->
<div id="sec1" class="section active">

<label>اسم الزبون</label>
<input id="name">

<label>رقم الهاتف</label>
<input id="phone">

<label>رقم الفاتورة</label>
<input id="invoice">

<label>نوع القطعة</label>
<select id="type">
  <option value="screen">شاشة</option>
  <option value="battery">بطارية</option>
</select>

<label>تاريخ التركيب (اليوم تلقائيًا)</label>
<input id="start" readonly>

<button onclick="sendData()">تفعيل الضمان</button>

<div id="result" class="result"></div>

</div>

<!-- التحقق -->
<div id="sec2" class="section">

<input id="inv" placeholder="أدخل رقم الفاتورة">
<button onclick="check()">بحث</button>

<div id="out" class="result" style="display:block"></div>

</div>

<a class="whatsapp" href="https://wa.me/9647709000160" target="_blank">
تواصل عبر واتساب
</a>

</div>

<script>
// Tabs
function showTab(n){
  document.querySelectorAll(".tab").forEach(t=>t.classList.remove("active"));
  document.querySelectorAll(".section").forEach(s=>s.classList.remove("active"));
  document.getElementById("tab"+n).classList.add("active");
  document.getElementById("sec"+n).classList.add("active");
}

// format date
function formatDate(d){
  const dt=new Date(d);
  return `${String(dt.getDate()).padStart(2,'0')}/${String(dt.getMonth()+1).padStart(2,'0')}/${dt.getFullYear()}`
}
document.getElementById("start").value = formatDate(new Date());

// safe getter
function gv(id){
  const el=document.getElementById(id);
  return el?(el.value||"").trim():"";
}

// === تفعيل الضمان مع منع التكرار ===
const SHEET =
 "https://docs.google.com/spreadsheets/d/e/2PACX-1vTraFUR-pqdM1dR-syL2zyxSNuQvDhNRnk95BkjBecronw6tB0jvAISLAMRuZpTIrLSp2DkeX-ElqUQ/pub?output=csv";

async function sendData(){

  const data={
    name:gv("name"),
    phone:gv("phone"),
    invoice:gv("invoice"),
    type:gv("type"),
    start:gv("start")
  };

  if(!data.name||!data.phone||!data.invoice){
    alert("الرجاء إدخال جميع الحقول");
    return;
  }

  // 1️⃣ منع التكرار — فحص الفاتورة
  let text = await (await fetch(SHEET)).text();
  let rows = text.split("\n").map(r=>r.split(","));
  let exists = rows.find(r => String(r[0]).trim() === data.invoice);

  if(exists){
    alert("⚠ هذا رقم الفاتورة مُسجّل مسبقاً — لا يمكن تفعيله مرة أخرى");
    return;
  }

  // 2️⃣ حساب انتهاء الضمان
  let days = data.type==="screen" ? 30 : 365;
  const [d,m,y]=data.start.split("/");
  const startDate=new Date(`${y}-${m}-${d}`);
  const expiry=new Date(startDate);
  expiry.setDate(expiry.getDate()+days);

  const res=document.getElementById("result");
  res.style.display="block";
  res.innerHTML=`⭐ تم تفعيل الضمان ⭐<br><br>
  تاريخ التفعيل: <b>${data.start}</b><br>
  الانتهاء: <b>${formatDate(expiry)}</b>
  <div id="timer" class="timer-box"></div>`;

  setInterval(()=>{
    const diff=expiry-new Date();
    if(diff<=0){document.getElementById("timer").innerHTML="انتهى الضمان";return;}
    document.getElementById("timer").innerHTML=
      "الوقت المتبقي: <b>"+Math.floor(diff/86400000)+"</b> يوم";
  },1000);

  // 3️⃣ إرسال للجدول
  fetch("https://eo9txe5hkh3d1yk.m.pipedream.net",{
    method:"POST",
    headers:{"Content-Type":"application/json"},
    body:JSON.stringify(data)
  }).catch(()=>alert("حدث خطأ — حاول مرة أخرى"));
}

// === التحقق من الضمان ===
async function check(){
  let v=gv("inv");
  if(!v) return alert("ادخل رقم الفاتورة");

  let text=await (await fetch(SHEET)).text();
  let rows=text.split("\n").map(r=>r.split(","));
  let r=rows.find(r=>String(r[0]).trim()===v);

  document.getElementById("out").innerHTML = r ?
   `✔️ تم العثور على الضمان<br>
    الاسم: ${r[1]}<br>
    الهاتف: ${r[2]}<br>
    النوع: ${r[3]}<br>
    تاريخ البدء: ${r[4]}<br>
    الانتهاء: ${r[5]}`
   : "❌ لم يتم العثور على الفاتورة";
}
</script>
</body>
</html>
