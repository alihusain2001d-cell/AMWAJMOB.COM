<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
<meta charset="UTF-8">
  <meta http-equiv="X-Content-Type-Options" content="nosniff">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="default">
<meta name="theme-color" content="#0284C7">
<link rel="icon" type="image/png" href="LOGO%20MOB.png">
<link rel="apple-touch-icon" href="LOGO%20MOB.png">
<link rel="manifest" href="manifest.json">
<title>Ø£Ù…ÙˆØ§Ø¬ Ù„Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠØ§Øª</title>
<link rel="preconnect" href="https://fonts.googleapis.com">
<link href="https://fonts.googleapis.com/css2?family=Tajawal:wght@400;500;700;800;900&display=swap" rel="stylesheet">
<style>
:root {
  --primary: #0284C7;
  --primary-dark: #0369A1;
  --accent: #0891B2;
  --primary-light: #EFF6FF;
  --surface: #F8FAFC;
  --card: #FFFFFF;
  --text: #0F172A;
  --muted: #64748B;
  --border: #E2E8F0;
  --green: #16A34A;
  --red: #DC2626;
  --orange: #F59E0B;
  --radius: 16px;
  --radius-sm: 10px;
  --shadow: 0 2px 12px rgba(2,132,199,0.1);
  --header-h: 60px;
  --footer-h: 65px;
}

* { margin:0; padding:0; box-sizing:border-box; -webkit-tap-highlight-color:transparent; }

body {
  font-family: 'Tajawal', sans-serif;
  font-size: 16px;
  background: var(--surface);
  color: var(--text);
  height: 100dvh;
  overflow: hidden;
  position: fixed;
  width: 100%;
}

/* â•â•â• APP SHELL â•â•â• */
.app-shell {
  display: flex;
  flex-direction: column;
  height: 100dvh;
  max-width: 480px;
  margin: 0 auto;
  position: relative;
  background: var(--surface);
  box-shadow: 0 0 40px rgba(0,0,0,0.15);
}

/* â”€â”€ Header â”€â”€ */
.app-header {
  height: var(--header-h);
  background: var(--card);
  border-bottom: 1px solid var(--border);
  display: flex;
  align-items: center;
  justify-content: space-between;
  padding: 0 16px;
  flex-shrink: 0;
  z-index: 100;
  position: relative;
}

.header-title {
  font-size: 17px;
  font-weight: 800;
  color: var(--text);
  letter-spacing: -0.3px;
}

.header-actions {
  display: flex;
  gap: 8px;
  align-items: center;
}

.header-icon-btn {
  width: 38px; height: 38px;
  border-radius: 50%;
  background: var(--primary-light);
  border: none;
  display: flex; align-items: center; justify-content: center;
  cursor: pointer;
  font-size: 18px;
  position: relative;
  transition: all 0.2s;
}
.header-icon-btn:active { transform: scale(0.92); }

.header-search-btn {
  background: var(--surface);
  border: 1.5px solid var(--border);
  border-radius: 10px;
  padding: 0 14px;
  height: 38px;
  display: flex; align-items: center; gap: 8px;
  cursor: pointer;
  flex: 1;
  max-width: 180px;
  color: var(--muted);
  font-size: 14px;
  font-family: 'Tajawal', sans-serif;
}

/* â”€â”€ Scrollable content â”€â”€ */
.app-body {
  flex: 1;
  overflow-y: auto;
  overflow-x: hidden;
  -webkit-overflow-scrolling: touch;
  scroll-behavior: smooth;
}

/* â”€â”€ Footer Nav â”€â”€ */
.app-footer {
  height: var(--footer-h);
  background: var(--card);
  border-top: 1px solid var(--border);
  display: flex;
  align-items: stretch;
  flex-shrink: 0;
  z-index: 100;
  padding-bottom: env(safe-area-inset-bottom, 0px);
}

.footer-tab {
  flex: 1;
  display: flex;
  flex-direction: column;
  align-items: center;
  justify-content: center;
  gap: 3px;
  cursor: pointer;
  border: none;
  background: none;
  font-family: 'Tajawal', sans-serif;
  transition: all 0.2s;
  position: relative;
  padding: 8px 4px;
}
.footer-tab:active { opacity: 0.7; }

.footer-tab-icon { font-size: 22px; line-height: 1; }
.footer-tab-label { font-size: 13px; font-weight: 600; color: var(--muted); }
.footer-tab.active .footer-tab-label { color: var(--primary); }
.footer-tab.active .footer-tab-icon { transform: scale(1.1); }

.footer-tab-badge {
  position: absolute;
  top: 4px; right: 50%;
  margin-right: -20px;
  background: #EF4444; color: white;
  border-radius: 50%; width: 18px; height: 18px;
  font-size: 10px; font-weight: 800;
  line-height: 18px; text-align: center;
  display: none;
  pointer-events: none;
}

/* â”€â”€ Center FAB (account) â”€â”€ */
.footer-fab {
  width: 56px; height: 56px;
  border-radius: 50%;
  background: linear-gradient(135deg, var(--primary), var(--accent));
  border: 4px solid var(--card);
  display: flex; align-items: center; justify-content: center;
  cursor: pointer;
  font-size: 22px;
  margin-top: -20px;
  box-shadow: 0 4px 16px rgba(2,132,199,0.4);
  transition: all 0.2s;
  flex-shrink: 0;
  align-self: flex-start;
}
.footer-fab:active { transform: scale(0.92); }

/* â•â•â• HOME PAGE â•â•â• */
.home-page { padding: 0 0 16px; }

/* Store card */
.store-card {
  background: linear-gradient(135deg, var(--primary) 0%, var(--accent) 100%);
  margin: 12px;
  border-radius: 18px;
  padding: 16px;
  color: white;
  display: flex;
  align-items: center;
  gap: 14px;
  box-shadow: 0 6px 24px rgba(2,132,199,0.35);
}
.store-logo {
  width: 56px; height: 56px;
  border-radius: 14px;
  background: rgba(255,255,255,0.2);
  display: flex; align-items: center; justify-content: center;
  overflow: hidden; flex-shrink: 0;
}
.store-logo img { width: 50px; height: 50px; object-fit: contain; }
.store-info { flex: 1; min-width: 0; }
.store-name { font-size: 17px; font-weight: 800; margin-bottom: 2px; }
.store-sub { font-size: 13px; opacity: 0.85; margin-bottom: 6px; }
.store-welcome {
  font-size: 12px;
  background: rgba(255,255,255,0.2);
  border-radius: 20px;
  padding: 3px 10px;
  display: inline-block;
}

/* Section labels */
.sec-label {
  font-size: 13px;
  font-weight: 700;
  color: var(--muted);
  letter-spacing: 0.5px;
  padding: 0 16px;
  margin: 14px 0 8px;
  display: flex;
  align-items: center;
  gap: 8px;
}
.sec-label::after {
  content: '';
  flex: 1;
  height: 1px;
  background: var(--border);
}

/* Quick actions strip */
.quick-strip {
  display: flex;
  gap: 10px;
  padding: 0 12px;
  margin-bottom: 4px;
}
.quick-btn {
  flex: 1;
  background: var(--card);
  border: 1.5px solid rgba(2,132,199,0.2);
  border-radius: 14px;
  padding: 12px 8px;
  text-align: center;
  cursor: pointer;
  transition: all 0.2s;
  position: relative;
}
.quick-btn:active { transform: scale(0.96); background: var(--primary-light); }
.quick-btn-icon { font-size: 22px; display: block; margin-bottom: 4px; }
.quick-btn-label { font-size: 12px; font-weight: 700; color: var(--text); }
.quick-badge {
  position: absolute; top: 6px; left: 6px;
  background: var(--red); color: white;
  border-radius: 50%; width: 16px; height: 16px;
  font-size: 9px; font-weight: bold;
  display: none; align-items: center; justify-content: center;
}

/* Search bar inside home */
.home-search {
  margin: 4px 12px 0;
  display: flex;
  align-items: center;
  gap: 10px;
  background: var(--card);
  border: 1.5px solid var(--border);
  border-radius: 12px;
  padding: 0 14px;
  height: 46px;
  transition: border 0.2s;
}
.home-search:focus-within { border-color: var(--primary); }
.home-search input {
  flex: 1; border: none; outline: none;
  font-size: 15px; font-family: 'Tajawal', sans-serif;
  background: transparent; color: var(--text);
}
.home-search input::placeholder { color: var(--muted); }

/* Products grid */
.products-grid {
  display: grid;
  grid-template-columns: repeat(4, 1fr);
  gap: 8px;
  padding: 0 12px;
}
.prod-card {
  background: var(--card);
  border: 1px solid var(--border);
  border-radius: 14px;
  padding: 12px 6px;
  text-align: center;
  cursor: pointer;
  transition: all 0.2s;
}
.prod-card:active { transform: scale(0.94); border-color: var(--primary); background: var(--primary-light); }
.prod-icon { font-size: 24px; display: block; margin-bottom: 5px; }
.prod-name { font-size: 13px; font-weight: 700; color: var(--text); line-height: 1.3; }
.prod-name-en { font-size: 9px; color: var(--muted); margin-top: 1px; }

/* Google card */
.google-card {
  margin: 12px;
  border-radius: 14px;
  background: linear-gradient(135deg, #1A73E8, #0F9D58);
  padding: 12px;
  box-shadow: 0 4px 16px rgba(26,115,232,0.25);
}
.google-card-title { color:white; font-weight:800; font-size:14px; text-align:center; margin-bottom:10px; }
.google-row { display:flex; gap:8px; margin-bottom:8px; }
.google-row input {
  flex:1; padding:10px 12px; border:none; border-radius:9px;
  font-size:14px; font-family:'Tajawal',sans-serif; margin:0; width:auto;
}
.google-row button {
  background:#fff; color:#1A73E8; padding:10px 14px; border:none;
  border-radius:9px; font-weight:700; cursor:pointer;
  width:auto; margin:0; font-family:'Tajawal',sans-serif; font-size:14px;
}
.google-lens-row { display:flex; gap:8px; }
.google-lens-row button {
  flex:1; background:rgba(255,255,255,0.2); color:white; padding:10px;
  border:none; border-radius:9px; font-weight:700; cursor:pointer;
  font-family:'Tajawal',sans-serif; font-size:13px; margin:0;
}

/* Contact */
.contact-strip {
  margin: 0 12px;
  display: flex;
  gap: 8px;
}
.contact-btn {
  flex: 1;
  background: var(--card);
  border: 1.5px solid rgba(2,132,199,0.3);
  border-radius: 14px;
  padding: 16px 8px;
  text-align: center;
  text-decoration: none;
  font-size: 22px;
  font-weight: 800;
  color: var(--primary);
  font-family: 'Tajawal', sans-serif;
  transition: all 0.2s;
  letter-spacing: 0.5px;
}
.contact-btn:active { background: var(--primary-light); }

.whatsapp-btn {
  display: block;
  margin: 8px 12px 0;
  background: #16A34A;
  color: white;
  text-align: center;
  padding: 13px;
  border-radius: 12px;
  font-size: 15px;
  font-weight: 800;
  text-decoration: none;
  font-family: 'Tajawal', sans-serif;
  box-shadow: 0 4px 14px rgba(22,163,74,0.3);
}

/* â•â•â• BOTTOM SHEETS â•â•â• */
.bsheet-overlay {
  display: none;
  position: fixed; inset: 0;
  background: rgba(15,23,42,0.55);
  z-index: 500;
  align-items: flex-end; justify-content: center;
  backdrop-filter: blur(4px);
}
.bsheet-overlay.open { display: flex; }
.bsheet {
  background: #fff;
  border-radius: 24px 24px 0 0;
  width: 100%; max-width: 480px;
  max-height: 90dvh;
  display: flex; flex-direction: column;
  animation: sheetUp .28s cubic-bezier(.32,.72,0,1);
}
@keyframes sheetUp { from{transform:translateY(100%);} to{transform:translateY(0);} }
.bsheet-handle { width:36px;height:4px;background:#E2E8F0;border-radius:2px;margin:10px auto 0;flex-shrink:0; }
.bsheet-head {
  display:flex; align-items:center; justify-content:space-between;
  padding:12px 16px 10px; flex-shrink:0;
  border-bottom:1px solid var(--border);
}
.bsheet-title { font-size:18px; font-weight:800; color:var(--text); }
.bsheet-close {
  width:30px; height:30px; border-radius:50%; border:none;
  background:#F1F5F9; color:var(--muted); font-size:16px;
  cursor:pointer; display:flex; align-items:center; justify-content:center;
  font-family:'Tajawal',sans-serif; padding:0; margin:0;
}
.bsheet-body { flex:1; overflow-y:auto; padding:14px 16px 32px; -webkit-overflow-scrolling:touch; }

/* Sheet search */
.bsheet-search-bar {
  display:flex; align-items:center; gap:8px;
  background:var(--surface); border:1.5px solid var(--border);
  border-radius:10px; padding:0 12px; height:42px; margin-bottom:12px;
}
.bsheet-search-bar input {
  flex:1; border:none; outline:none;
  font-size:14px; font-family:'Tajawal',sans-serif;
  background:transparent;
}

/* Sheet brand buttons */
.sheet-brands { display:grid; grid-template-columns:repeat(2,1fr); gap:8px; margin-bottom:12px; }
.sheet-brand-btn {
  background:var(--surface); border:1.5px solid var(--border);
  border-radius:12px; padding:12px 10px; text-align:center;
  cursor:pointer; transition:all .2s;
}
.sheet-brand-btn:active { background:var(--primary-light); border-color:var(--primary); }
.sheet-brand-btn b { display:block; font-size:15px; color:var(--text); }
.sheet-brand-btn small { font-size:10px; color:var(--muted); }

/* Price items */
.price-item {
  background:var(--surface); border:1px solid var(--border);
  border-radius:12px; padding:12px; margin-bottom:8px;
}
.pi-name { font-weight:700; font-size:17px; }
.pi-brand { font-size:14px; color:var(--muted); margin-top:2px; }
.pi-type { display:inline-block; padding:3px 10px; border-radius:20px; font-size:12px; font-weight:700; background:#F0FDF4; color:#166534; margin-top:5px; }
.pi-price { font-size:19px; font-weight:800; margin-top:6px; }
.pi-price.avail { color:var(--primary); }
.pi-price.unavail { color:var(--red); }
.pi-notes { background:#FFF7ED; border-right:3px solid var(--orange); padding:7px 10px; border-radius:8px; font-size:15px; color:#92400E; font-weight:600; margin-top:6px; }
.add-to-cart-btn {
  background:var(--green); color:white; padding:11px; border-radius:9px;
  border:none; cursor:pointer; margin-top:8px; width:100%;
  font-weight:700; font-size:16px; font-family:'Tajawal',sans-serif;
}

/* Form inside sheet */
.form-group { margin-bottom:12px; }
.form-label { font-weight:700; font-size:13px; color:var(--text); margin-bottom:5px; display:block; }
.form-input {
  width:100%; padding:11px 12px; border:1.5px solid var(--border);
  border-radius:10px; font-size:15px; font-family:'Tajawal',sans-serif;
  margin:0; transition:border .2s; outline:none;
}
.form-input:focus { border-color:var(--primary); }
.form-btn {
  width:100%; padding:13px; background:var(--primary); color:white;
  border:none; border-radius:12px; font-size:16px; font-weight:800;
  cursor:pointer; font-family:'Tajawal',sans-serif;
  box-shadow:0 4px 14px rgba(2,132,199,0.3); margin-top:4px;
}
.form-btn:disabled { background:#CBD5E1; box-shadow:none; cursor:not-allowed; }
.form-btn.danger { background:var(--red); box-shadow:0 4px 14px rgba(220,38,38,0.3); }
.form-btn.success-btn { background:var(--green); box-shadow:0 4px 14px rgba(22,163,74,0.3); }
.form-btn.gray { background:#64748B; box-shadow:none; }

/* Results */
.result { padding:12px; border-radius:10px; margin-top:10px; font-size:14px; line-height:1.7; }
.result.success { background:#F0FDF4; color:#166534; border:1px solid #86EFAC; }
.result.error { background:#FEF2F2; color:#991B1B; border:1px solid #FECACA; }
.result.pending { background:#FFFBEB; color:#92400E; border:1px solid #FDE68A; }

/* Order cards */
.order-status-bar{display:flex;align-items:flex-start;margin:10px 0 8px;direction:rtl;}
.order-step{flex:1;text-align:center;position:relative;}
.order-step:not(:last-child)::after{content:'';position:absolute;top:12px;right:50%;width:100%;height:3px;background:var(--border);z-index:0;}
.order-step.done::after{background:var(--green);}
.step-dot{width:26px;height:26px;border-radius:50%;background:var(--border);display:inline-flex;align-items:center;justify-content:center;font-size:12px;position:relative;z-index:1;}
.order-step.done .step-dot{background:var(--green);color:#fff;}
.order-step.active .step-dot{background:var(--primary);color:#fff;box-shadow:0 0 0 4px rgba(2,132,199,.2);}
.step-txt{font-size:10px;color:#94A3B8;margin-top:3px;}
.order-step.done .step-txt,.order-step.active .step-txt{color:var(--text);font-weight:700;}
.order-card{background:var(--card);border:1px solid var(--border);border-radius:14px;padding:14px;margin:8px 0;box-shadow:var(--shadow);}
.order-card-header{display:flex;justify-content:space-between;align-items:center;margin-bottom:6px;}
.order-id-text{font-weight:800;font-size:14px;}
.status-pill{padding:4px 10px;border-radius:20px;font-size:11px;font-weight:700;}
.pill-pending{background:#FEF9C3;color:#854D0E;}
.pill-picked{background:#FFF7ED;color:#C2410C;}
.pill-delivered{background:#DCFCE7;color:#166534;}
.pill-cancelled{background:#FEE2E2;color:#991B1B;}
.order-item-row{font-size:13px;color:#475569;padding:3px 0;border-bottom:1px solid #F1F5F9;}
.order-item-row:last-child{border:none;}
.cancel-order-btn{width:100%;padding:10px;border-radius:9px;border:1.5px solid #FEE2E2;background:white;color:var(--red);font-size:13px;font-weight:700;cursor:pointer;margin-top:8px;font-family:'Tajawal',sans-serif;}

/* Cart */
.cart-item{background:var(--surface);padding:12px;margin:6px 0;border-radius:10px;border:1px solid var(--border);}
.cart-item-info{width:100%;}

/* Loading */
.loading-spinner{border:3px solid var(--border);border-top:3px solid var(--primary);border-radius:50%;width:36px;height:36px;animation:spin 1s linear infinite;margin:20px auto;}
@keyframes spin{0%{transform:rotate(0);}100%{transform:rotate(360deg);}}
.loading-text{color:var(--primary);font-size:15px;margin-top:8px;text-align:center;}

/* flatpower modal */
#flatpowerModal{display:none;position:fixed;inset:0;background:rgba(15,23,42,0.55);z-index:600;align-items:flex-end;justify-content:center;backdrop-filter:blur(4px);}
#flatpowerModal.active{display:flex;}
.flatpower-sheet{background:white;border-radius:24px 24px 0 0;width:100%;max-width:480px;animation:sheetUp .28s cubic-bezier(.32,.72,0,1);max-height:85dvh;overflow-y:auto;padding:0 0 24px;}
.flatpower-handle{width:36px;height:4px;background:#E2E8F0;border-radius:2px;margin:10px auto 0;}
.fp-head{text-align:center;font-size:16px;font-weight:800;padding:12px 16px 4px;}
.fp-grid{display:grid;grid-template-columns:repeat(2,1fr);gap:8px;padding:12px 16px;}
.fp-btn{background:var(--surface);border:1.5px solid var(--border);border-radius:12px;padding:14px 10px;text-align:center;cursor:pointer;transition:all .2s;}
.fp-btn:active{background:var(--primary-light);border-color:var(--primary);}
.fp-icon{font-size:24px;display:block;margin-bottom:5px;}
.fp-label{font-size:13px;font-weight:700;color:var(--text);}
.fp-sub{font-size:10px;color:var(--muted);margin-top:2px;}
.fp-close{display:block;width:calc(100% - 32px);margin:0 16px;padding:12px;background:var(--red);color:white;border:none;border-radius:12px;font-size:15px;font-weight:700;cursor:pointer;font-family:'Tajawal',sans-serif;}

/* Register / Login pages */
.auth-page { padding: 20px 16px; }
.auth-logo { text-align:center; margin-bottom: 16px; }
.auth-logo img { width: 90px; }
.auth-title { text-align:center; font-size:20px; font-weight:800; color:var(--primary); margin-bottom:6px; }
.auth-sub { text-align:center; font-size:14px; color:var(--muted); margin-bottom:20px; line-height:1.6; }
.switch-link { text-align:center; margin-top:16px; padding-top:16px; border-top:1px solid var(--border); }
.switch-link p { font-size:14px; color:var(--muted); margin-bottom:8px; }

/* Hidden compat */
#pricesPage, #cartPage, #activatePage, #checkPage, #myOrdersPage, #homePage, #loadingPage, #registerPage, #loginPage { display:none !important; }
#brandsGrid, #brandPricesBox, #pricesTitle, #searchInput, #backToTopBtn { display:none !important; }

/* Cart badge (floating) */
#cartBadge {
  position: fixed; bottom: calc(var(--footer-h) + 16px); left: 16px;
  background: var(--green); color: white;
  border-radius: 50%; width: 50px; height: 50px;
  display: none; align-items: center; justify-content: center;
  font-size: 22px; cursor: pointer;
  box-shadow: 0 4px 16px rgba(22,163,74,0.4); z-index: 400;
}
.cart-count {
  position: absolute; top: -4px; right: -4px;
  background: var(--red); color: white; border-radius: 50%;
  width: 18px; height: 18px; font-size: 10px; font-weight: bold;
  display: flex; align-items: center; justify-content: center;
}

/* Info box */
.info-box{background:var(--primary-light);padding:12px;border-radius:10px;margin:10px 0;text-align:center;border:1px solid #BFDBFE;}

@media (min-width: 480px) {
  .app-shell { border-radius: 20px; margin-top: 20px; height: calc(100dvh - 40px); }
}
</style>
</head>
<body>

<!-- Cart floating btn -->
<div id="cartBadge" onclick="openCartSheet()">ğŸ›’<span id="cartCount" class="cart-count">0</span></div>

<!-- flatpower modal -->
<div id="flatpowerModal" onclick="closeFlatpowerModal(event)">
  <div class="flatpower-sheet" onclick="event.stopPropagation()">
    <div class="flatpower-handle"></div>
    <div class="fp-head">ğŸ”§ Ù‚Ø·Ø¹ ØºÙŠØ§Ø± Ù…Ù†ÙˆØ¹Ø©</div>
    <div class="fp-grid">
      <div class="fp-btn" onclick="openFlatSub('FLAT POWER','ÙÙ„Ø§Øª Ø¨ÙˆØ±','âš¡')"><span class="fp-icon">âš¡</span><div class="fp-label">ÙÙ„Ø§Øª Ø¨ÙˆØ±</div><div class="fp-sub">FLAT POWER</div></div>
      <div class="fp-btn" onclick="openFlatSub('FLAT VOLUME','ÙÙ„Ø§Øª ØµÙˆØª','ğŸ”‰')"><span class="fp-icon">ğŸ”‰</span><div class="fp-label">ÙÙ„Ø§Øª ØµÙˆØª</div><div class="fp-sub">FLAT VOLUME</div></div>
      <div class="fp-btn" onclick="openFlatSub('BUZZER','Ø³Ù…Ø§Ø¹Ø© Ø¬Ø±Ø³','ğŸ””')"><span class="fp-icon">ğŸ””</span><div class="fp-label">Ø³Ù…Ø§Ø¹Ø© Ø¬Ø±Ø³</div><div class="fp-sub">BUZZER</div></div>
      <div class="fp-btn" onclick="openFlatSub('EAR SPEAKER','Ø³Ù…Ø§Ø¹Ø© Ø§ØªØµØ§Ù„','ğŸ“')"><span class="fp-icon">ğŸ“</span><div class="fp-label">Ø³Ù…Ø§Ø¹Ø© Ø§ØªØµØ§Ù„</div><div class="fp-sub">EAR SPEAKER</div></div>
      <div class="fp-btn" onclick="openFlatSub('DOOR SIM','Ø¨Ø§Ø¨ Ø³ÙŠÙ… ÙƒØ§Ø±Øª','ğŸ’³')"><span class="fp-icon">ğŸ’³</span><div class="fp-label">Ø¨Ø§Ø¨ Ø³ÙŠÙ… ÙƒØ§Ø±Øª</div><div class="fp-sub">DOOR SIM</div></div>
      <div class="fp-btn" onclick="openFlatSub('FINGERPRINT','Ø¨ØµÙ…Ø©','ğŸ‘†')"><span class="fp-icon">ğŸ‘†</span><div class="fp-label">Ø¨ØµÙ…Ø©</div><div class="fp-sub">FINGERPRINT</div></div>
      <div class="fp-btn" onclick="openFlatSub('OTHER','Ù…Ù†ÙˆØ¹Ø©','ğŸ“¦')"><span class="fp-icon">ğŸ“¦</span><div class="fp-label">Ù…Ù†ÙˆØ¹Ø©</div><div class="fp-sub">OTHER</div></div>
      <div class="fp-btn" onclick="openLensFromModal()"><span class="fp-icon">ğŸ“·</span><div class="fp-label">Ø¹Ø¯Ø³Ø© ÙƒØ§Ù…ÙŠØ±Ø§</div><div class="fp-sub">LENS CAMERA</div></div>
    </div>
    <button class="fp-close" onclick="closeFlatpowerModal()">âœ• Ø¥ØºÙ„Ø§Ù‚</button>
  </div>
</div>

<!-- BOTTOM SHEETS -->
<div id="productsSheet" class="bsheet-overlay" onclick="closeSheet('productsSheet')">
  <div class="bsheet" onclick="event.stopPropagation()">
    <div class="bsheet-handle"></div>
    <div class="bsheet-head">
      <span id="productsSheetTitle" class="bsheet-title">ğŸ–¥ï¸ Ø§Ù„Ø´Ø§Ø´Ø§Øª</span>
      <button class="bsheet-close" onclick="closeSheet('productsSheet')">âœ•</button>
    </div>
    <div class="bsheet-body">
      <div class="bsheet-search-bar"><span>ğŸ”</span><input type="text" id="sheetSearch" placeholder="Ø§Ø¨Ø­Ø« Ø¹Ù† Ù…ÙˆØ¯ÙŠÙ„..." oninput="handleSheetSearch()"></div>
      <div id="sheetBrands" class="sheet-brands"></div>
      <div id="sheetResults"></div>
    </div>
  </div>
</div>

<div id="warrantySheet" class="bsheet-overlay" onclick="closeSheet('warrantySheet')">
  <div class="bsheet" onclick="event.stopPropagation()">
    <div class="bsheet-handle"></div>
    <div class="bsheet-head"><span class="bsheet-title">âœ… ØªÙØ¹ÙŠÙ„ Ø§Ù„Ø¶Ù…Ø§Ù†</span><button class="bsheet-close" onclick="closeSheet('warrantySheet')">âœ•</button></div>
    <div class="bsheet-body">
      <div class="form-group"><label class="form-label">Ø§Ø³Ù… Ø§Ù„Ø²Ø¨ÙˆÙ†</label><input class="form-input" id="name" placeholder="Ù…Ø«Ø§Ù„: Ø£Ø­Ù…Ø¯ Ù…Ø­Ù…Ø¯"></div>
      <div class="form-group"><label class="form-label">Ø±Ù‚Ù… Ø§Ù„Ù‡Ø§ØªÙ</label><input class="form-input" id="phone" type="tel"></div>
      <div class="form-group"><label class="form-label">Ø±Ù‚Ù… Ø§Ù„ÙØ§ØªÙˆØ±Ø©</label><input class="form-input" id="invoice"></div>
      <div class="form-group"><label class="form-label">ÙƒÙˆØ¯ Ø§Ù„Ø´Ø§Ø´Ø©</label><input class="form-input" id="screenCode" placeholder="Ø§Ù„ÙƒÙˆØ¯ Ø®Ù„Ù Ø§Ù„Ø´Ø§Ø´Ø©"></div>
      <div class="form-group"><label class="form-label">Ø§Ø³Ù… Ø§Ù„Ø´Ø§Ø´Ø© (Ø§Ø®ØªÙŠØ§Ø±ÙŠ)</label><input class="form-input" id="screenName" placeholder="Ù…Ø«Ø§Ù„: iPhone 11 Pro"></div>
      <div class="form-group"><label class="form-label">Ù†ÙˆØ¹ Ø§Ù„Ù‚Ø·Ø¹Ø©</label><select class="form-input" id="type"><option value="screen">Ø´Ø§Ø´Ø©</option><option value="battery">Ø¨Ø·Ø§Ø±ÙŠØ©</option></select></div>
      <div class="form-group"><label class="form-label">ØªØ§Ø±ÙŠØ® Ø§Ù„ØªØ±ÙƒÙŠØ¨</label><input class="form-input" id="start" readonly></div>
      <div id="dupMsg" style="display:none;background:#FEF2F2;color:#991B1B;padding:10px;border-radius:10px;margin:10px 0;border:1px solid #FECACA;font-size:13px;"></div>
      <button class="form-btn" id="btnActivate" onclick="sendData()">ØªÙØ¹ÙŠÙ„ Ø§Ù„Ø¶Ù…Ø§Ù†</button>
      <div id="result"></div>
    </div>
  </div>
</div>

<div id="checkSheet" class="bsheet-overlay" onclick="closeSheet('checkSheet')">
  <div class="bsheet" onclick="event.stopPropagation()">
    <div class="bsheet-handle"></div>
    <div class="bsheet-head"><span class="bsheet-title">ğŸ” Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„Ø¶Ù…Ø§Ù†</span><button class="bsheet-close" onclick="closeSheet('checkSheet')">âœ•</button></div>
    <div class="bsheet-body">
      <div class="form-group"><label class="form-label">Ø£Ø¯Ø®Ù„ ÙƒÙˆØ¯ Ø§Ù„Ø´Ø§Ø´Ø©</label><input class="form-input" id="inv" placeholder="ÙƒÙˆØ¯ Ø§Ù„Ø´Ø§Ø´Ø©..."></div>
      <button class="form-btn" onclick="checkWarranty()">ğŸ” Ø¨Ø­Ø«</button>
      <div id="out"></div>
    </div>
  </div>
</div>

<div id="ordersSheet" class="bsheet-overlay" onclick="closeSheet('ordersSheet')">
  <div class="bsheet" onclick="event.stopPropagation()">
    <div class="bsheet-handle"></div>
    <div class="bsheet-head"><span class="bsheet-title">ğŸ“¦ Ø·Ù„Ø¨Ø§ØªÙŠ</span><button class="bsheet-close" onclick="closeSheet('ordersSheet')">âœ•</button></div>
    <div class="bsheet-body">
      <div id="myOrdersLoading" style="text-align:center;padding:30px;"><div class="loading-spinner"></div><div class="loading-text">Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ù…ÙŠÙ„...</div></div>
      <div id="myOrdersList"></div>
    </div>
  </div>
</div>

<div id="cartSheet" class="bsheet-overlay" onclick="closeSheet('cartSheet')">
  <div class="bsheet" onclick="event.stopPropagation()">
    <div class="bsheet-handle"></div>
    <div class="bsheet-head"><span class="bsheet-title">ğŸ›’ Ø³Ù„Ø© Ø§Ù„Ù…Ø´ØªØ±ÙŠØ§Øª</span><button class="bsheet-close" onclick="closeSheet('cartSheet')">âœ•</button></div>
    <div class="bsheet-body">
      <div id="cartItems"></div>
      <div id="cartSummary" style="display:none;background:var(--primary-light);padding:12px;border-radius:10px;margin:10px 0;border:1px solid #BFDBFE;">
        <div style="display:flex;justify-content:space-between;font-size:17px;font-weight:800;"><span>Ø§Ù„Ù…Ø¬Ù…ÙˆØ¹:</span><span id="cartTotal" style="color:var(--primary);">0</span></div>
      </div>
      <button onclick="clearCart()" class="form-btn danger" id="clearCartBtn" style="display:none;margin-bottom:10px;">ğŸ—‘ï¸ Ø¥ÙØ±Ø§Øº Ø§Ù„Ø³Ù„Ø©</button>
      <div id="orderForm" style="display:none;">
        <div style="text-align:center;font-size:15px;font-weight:800;color:var(--primary);margin:12px 0 10px;">Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„ØªÙˆØµÙŠÙ„</div>
        <div class="form-group"><label class="form-label">Ø§Ù„Ø§Ø³Ù…</label><input class="form-input" type="text" id="orderName"></div>
        <div class="form-group"><label class="form-label">Ø§Ø³Ù… Ø§Ù„Ù…Ø­Ù„</label><input class="form-input" type="text" id="orderShop"></div>
        <div class="form-group"><label class="form-label">Ø§Ù„Ø¹Ù†ÙˆØ§Ù†</label><input class="form-input" type="text" id="orderAddress"></div>
        <button onclick="submitOrder()" class="form-btn success-btn">ğŸ“¤ Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø·Ù„Ø¨</button>
        <div id="orderResult"></div>
      </div>
    </div>
  </div>
</div>

<div id="accountSheet" class="bsheet-overlay" onclick="closeSheet('accountSheet')">
  <div class="bsheet" onclick="event.stopPropagation()">
    <div class="bsheet-handle"></div>
    <div class="bsheet-head"><span class="bsheet-title">ğŸ‘¤ Ø§Ù„Ø­Ø³Ø§Ø¨</span><button class="bsheet-close" onclick="closeSheet('accountSheet')">âœ•</button></div>
    <div class="bsheet-body">
      <div id="accountContent"></div>
    </div>
  </div>
</div>


<!-- New Items Sheet -->
<div id="newItemsSheet" class="bsheet-overlay" onclick="closeSheet('newItemsSheet')">
  <div class="bsheet" onclick="event.stopPropagation()">
    <div class="bsheet-handle"></div>
    <div class="bsheet-head">
      <span class="bsheet-title">âœ¨ ÙˆØµÙ„ Ø¬Ø¯ÙŠØ¯</span>
      <button class="bsheet-close" onclick="closeSheet('newItemsSheet')">âœ•</button>
    </div>
    <div class="bsheet-body" id="newItemsSheetBody">
      <div style="text-align:center;padding:30px;">
        <div class="loading-spinner" style="margin:0 auto;"></div>
      </div>
    </div>
  </div>
</div>



<!-- Search Sheet -->
<div id="searchSheet" class="bsheet-overlay" onclick="closeSheet('searchSheet')">
  <div class="bsheet" onclick="event.stopPropagation()">
    <div class="bsheet-handle"></div>
    <div class="bsheet-head">
      <span class="bsheet-title">ğŸ” Ø¨Ø­Ø« ÙÙŠ ÙƒÙ„ Ø§Ù„Ù…ÙˆØ§Ø¯</span>
      <button class="bsheet-close" onclick="closeSheet('searchSheet')">âœ•</button>
    </div>
    <div class="bsheet-body">
      <div class="bsheet-search-bar" style="margin-bottom:14px;">
        <span style="font-size:18px;">ğŸ”</span>
        <input type="text" id="globalSheetSearch" placeholder="Ø§Ø¨Ø­Ø« Ø¹Ù† Ø£ÙŠ Ù…Ù†ØªØ¬..." oninput="doGlobalSheetSearch()" autofocus>
      </div>
      <div id="globalSheetResults">
        <div style="text-align:center;padding:30px;color:#94A3B8;font-size:14px;">Ø§ÙƒØªØ¨ Ø§Ø³Ù… Ø§Ù„Ù…Ù†ØªØ¬ Ù„Ù„Ø¨Ø­Ø«...</div>
      </div>
    </div>
  </div>
</div>


<!-- APP SHELL -->
<div class="app-shell">

  <!-- Header -->
  <div class="app-header">
    <button class="header-icon-btn" onclick="openSheet('accountSheet');renderAccountSheet();" title="Ø­Ø³Ø§Ø¨ÙŠ">ğŸ‘¤</button>
    <div class="header-title">Ø£Ù…ÙˆØ§Ø¬ Ù„Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠØ§Øª</div>
    <div style="display:flex;gap:6px;">
      <button class="header-icon-btn" onclick="focusHomeSearch()" title="Ø¨Ø­Ø«">ğŸ”</button>
      <button class="header-icon-btn" onclick="openCartSheet()" title="Ø§Ù„Ø³Ù„Ø©" style="position:relative;">
        ğŸ›’
        <span id="headerCartBadge" style="display:none;position:absolute;top:-3px;left:-3px;background:#EF4444;color:white;border-radius:50%;min-width:17px;height:17px;font-size:10px;font-weight:800;line-height:17px;text-align:center;padding:0 3px;"></span>
      </button>
    </div>
  </div>

  <!-- Body -->
  <div class="app-body" id="appBody">

    <!-- Loading screen -->
    <div id="loadingScreen" style="display:flex;flex-direction:column;align-items:center;justify-content:center;height:100%;text-align:center;padding:20px;">
      <img src="1646237145252.png" alt="Ø£Ù…ÙˆØ§Ø¬" style="width:100px;margin-bottom:16px;" onerror="this.style.display='none'">
      <div class="loading-spinner"></div>
      <div class="loading-text">Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ù…ÙŠÙ„...</div>
    </div>

    <!-- Register -->
    <div id="registerScreen" style="display:none;" class="auth-page">
      <div class="auth-logo"><img src="1646237145252.png" alt="Ø£Ù…ÙˆØ§Ø¬" onerror="this.style.display='none'"></div>
      <div class="auth-title">ØªØ³Ø¬ÙŠÙ„ Ø­Ø³Ø§Ø¨ Ø¬Ø¯ÙŠØ¯</div>
      <div class="auth-sub">Ø£Ù‡Ù„Ø§Ù‹ Ø¨Ùƒ ÙÙŠ Ø£Ù…ÙˆØ§Ø¬ Ù„Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠØ§Øª<br>Ø³Ø¬Ù„ Ø¨ÙŠØ§Ù†Ø§ØªÙƒ Ù„Ù„ÙˆØµÙˆÙ„ Ù„Ù„Ø£Ø³Ø¹Ø§Ø± ÙˆØ§Ù„Ø¶Ù…Ø§Ù†</div>
      <div class="form-group"><label class="form-label">Ø§Ù„Ø§Ø³Ù… Ø§Ù„Ø«Ù„Ø§Ø«ÙŠ</label><input class="form-input" type="text" id="regName" placeholder="Ù…Ø«Ø§Ù„: Ø£Ø­Ù…Ø¯ Ù…Ø­Ù…Ø¯ Ø¹Ù„ÙŠ"></div>
      <div class="form-group"><label class="form-label">Ø§Ø³Ù… Ø§Ù„Ù…Ø­Ù„</label><input class="form-input" type="text" id="regShop" placeholder="Ø§Ø³Ù… Ù…Ø­Ù„Ùƒ"></div>
      <div class="form-group"><label class="form-label">Ø±Ù‚Ù… Ø§Ù„Ù‡Ø§ØªÙ</label><input class="form-input" type="tel" id="regPhone" placeholder="07xxxxxxxxx"></div>
      <button class="form-btn" id="btnRegister" onclick="submitRegistration()">Ø¥Ø±Ø³Ø§Ù„ Ø·Ù„Ø¨ Ø§Ù„ØªØ³Ø¬ÙŠÙ„</button>
      <div id="regResult"></div>
      <div class="switch-link"><p>Ø¹Ù†Ø¯Ùƒ Ø­Ø³Ø§Ø¨ Ù…Ø³Ø¨Ù‚Ø§Ù‹ØŸ</p><button class="form-btn gray" onclick="showScreen('loginScreen')">ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„</button></div>
      <div class="info-box" style="margin-top:16px;">ğŸ“ Ù„Ù„Ø§Ø³ØªÙØ³Ø§Ø±:<br>
        <a href="tel:7696" style="font-weight:bold;color:var(--primary);">ğŸ“± 7696</a> &nbsp;
        <a href="tel:07709000160" style="font-weight:bold;color:var(--primary);">ğŸ“± 07709000160</a>
      </div>
    </div>

    <!-- Login -->
    <div id="loginScreen" style="display:none;" class="auth-page">
      <div class="auth-logo"><img src="1646237145252.png" alt="Ø£Ù…ÙˆØ§Ø¬" onerror="this.style.display='none'"></div>
      <div class="auth-title">ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„</div>
      <div class="auth-sub">Ø£Ù‡Ù„Ø§Ù‹ Ø¨Ùƒ Ù…Ø¬Ø¯Ø¯Ø§Ù‹ ğŸŒŠ<br>Ø£Ø¯Ø®Ù„ Ø±Ù‚Ù… Ù‡Ø§ØªÙÙƒ Ù„Ù„Ø¯Ø®ÙˆÙ„</div>
      <div class="form-group"><label class="form-label">Ø±Ù‚Ù… Ø§Ù„Ù‡Ø§ØªÙ</label><input class="form-input" type="tel" id="loginPhone" placeholder="07xxxxxxxxx"></div>
      <button class="form-btn" id="btnLogin" onclick="checkLogin()">Ø¯Ø®ÙˆÙ„</button>
      <div id="loginResult"></div>
      <div class="switch-link"><p>Ù…Ø§ Ø¹Ù†Ø¯Ùƒ Ø­Ø³Ø§Ø¨ØŸ</p><button class="form-btn success-btn" onclick="showScreen('registerScreen')">ØªØ³Ø¬ÙŠÙ„ Ø­Ø³Ø§Ø¨ Ø¬Ø¯ÙŠØ¯</button></div>
    </div>

    <!-- HOME -->
    <div id="homeScreen" style="display:none;" class="home-page">

      <!-- Store card -->
      <div class="store-card">
        <div class="store-logo">
          <img src="1646237145252.png" alt="Ø£Ù…ÙˆØ§Ø¬" onerror="this.style.display='none'">
        </div>
        <div class="store-info">
          <div class="store-name">Ø£Ù…ÙˆØ§Ø¬ Ù„Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠØ§Øª</div>
          <div class="store-sub"> Ù‚Ø·Ø¹ ØºÙŠØ§Ø± Ù…ÙˆØ¨Ø§ÙŠÙ„ â€” ÙƒØ±Ø¨Ù„Ø§Ø¡ Ø§Ù„Ù…Ù‚Ø¯Ø³Ø©</div>
          <div class="store-welcome" id="storeWelcome">Ø£Ù‡Ù„Ø§Ù‹ Ø¨Ùƒ ğŸ‘‹</div>
        </div>
      </div>

      <!-- Quick actions -->
      <div class="sec-label">Ø¥Ø¬Ø±Ø§Ø¡Ø§Øª Ø³Ø±ÙŠØ¹Ø©</div>
      <div class="quick-strip">
        <div class="quick-btn" onclick="requireAuth(function(){openSheet('warrantySheet');document.getElementById('start').value=formatDate(new Date());})">
          <span class="quick-btn-icon">âœ…</span>
          <div class="quick-btn-label">ØªÙØ¹ÙŠÙ„ Ø§Ù„Ø¶Ù…Ø§Ù†</div>
        </div>
        <div class="quick-btn" onclick="requireAuth(function(){openSheet('checkSheet');})">
          <span class="quick-btn-icon">ğŸ”</span>
          <div class="quick-btn-label">Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„Ø¶Ù…Ø§Ù†</div>
        </div>
        <div class="quick-btn" onclick="requireAuth(function(){openOrdersSheet();})" style="position:relative;">
          <span class="quick-btn-icon">ğŸ“¦</span>
          <div class="quick-btn-label">Ø·Ù„Ø¨Ø§ØªÙŠ</div>
          <span class="quick-badge" id="ordersBadge"></span>
        </div>
      </div>

      <!-- Search -->
      <div class="sec-label">Ø¨Ø­Ø« Ø³Ø±ÙŠØ¹</div>
      <div class="home-search" style="margin:0 12px 0;">
        <span style="font-size:18px;color:var(--muted);">ğŸ”</span>
        <input type="text" id="globalSearch" placeholder="Ø§Ø¨Ø­Ø« Ø¹Ù† Ù…Ù†ØªØ¬... (Ù…Ø«Ø§Ù„: A10)" onkeyup="handleGlobalSearch(event)">
      </div>
      <div id="globalSearchResults" style="padding:0 12px;margin-top:8px;display:none;"></div>

      <!-- Products -->
      <div class="sec-label">Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª</div>
      <div class="products-grid">
        <div class="prod-card" onclick="requireAuth(function(){openProductSheet('screens','ğŸ–¥ï¸ Ø§Ù„Ø´Ø§Ø´Ø§Øª');})">
          <span class="prod-icon">ğŸ–¥ï¸</span><div class="prod-name">Ø§Ù„Ø´Ø§Ø´Ø§Øª</div><div class="prod-name-en">Screens</div>
        </div>
        <div class="prod-card" onclick="requireAuth(function(){openProductSheet('batteries','ğŸ”‹ Ø§Ù„Ø¨Ø·Ø§Ø±ÙŠØ§Øª');})">
          <span class="prod-icon">ğŸ”‹</span><div class="prod-name">Ø§Ù„Ø¨Ø·Ø§Ø±ÙŠØ§Øª</div><div class="prod-name-en">Batteries</div>
        </div>
        <div class="prod-card" onclick="requireAuth(function(){openProductSheet('chargeboards','ğŸ”Œ Ø¨ÙˆØ±Ø¯ Ø´Ø­Ù†');})">
          <span class="prod-icon">ğŸ”Œ</span><div class="prod-name">Ø¨ÙˆØ±Ø¯ Ø´Ø­Ù†</div><div class="prod-name-en">Charge Board</div>
        </div>
        <div class="prod-card" onclick="requireAuth(function(){openProductSheet('flatcharging','âš¡ Ø´Ø±ÙŠØ· Ø´Ø­Ù†');})">
          <span class="prod-icon">âš¡</span><div class="prod-name">Ø´Ø±ÙŠØ· Ø´Ø­Ù†</div><div class="prod-name-en">Charging Flex</div>
        </div>
        <div class="prod-card" onclick="requireAuth(function(){openFlatpowerModal();})">
          <span class="prod-icon">ğŸ”Š</span><div class="prod-name">Ù‚Ø·Ø¹ Ù…Ù†ÙˆØ¹Ø©</div><div class="prod-name-en">Misc Parts</div>
        </div>
        <div class="prod-card" onclick="requireAuth(function(){openProductSheet('backcover','ğŸ“± Ø¨Ø§Ùƒ ÙƒÙØ±');})">
          <span class="prod-icon">ğŸ“±</span><div class="prod-name">Ø¨Ø§Ùƒ ÙƒÙØ±</div><div class="prod-name-en">Back Cover</div>
        </div>
        <div class="prod-card" onclick="requireAuth(function(){openProductSheet('housing','ğŸ  Ø´Ø§ØµÙŠ');})">
          <span class="prod-icon">ğŸ </span><div class="prod-name">Ø´Ø§ØµÙŠ</div><div class="prod-name-en">Housing</div>
        </div>
        <div class="prod-card" onclick="requireAuth(function(){openProductSheet('camera','ğŸ“· ÙƒØ§Ù…ÙŠØ±Ø§');})">
          <span class="prod-icon">ğŸ“·</span><div class="prod-name">ÙƒØ§Ù…ÙŠØ±Ø§</div><div class="prod-name-en">Camera</div>
        </div>
      </div>

            <!-- Contact -->
      <div class="sec-label">ØªÙˆØ§ØµÙ„ Ù…Ø¹Ù†Ø§</div>
      <div class="contact-strip">
        <a href="tel:7696" class="contact-btn">ğŸ“± 7696</a>
        <a href="tel:07709000160" class="contact-btn">ğŸ“± 07709000160</a>
      </div>
      <a href="https://wa.me/9647709000160" target="_blank" class="whatsapp-btn" style="font-size:19px;padding:16px;">ğŸŸ¢ ÙˆØ§ØªØ³Ø§Ø¨</a>

      <div style="height:16px;"></div>
    </div>
  </div>

  <!-- Footer nav -->
  <div class="app-footer">
    <button class="footer-tab active" id="tab-home" onclick="footerTab('home')">
      <span class="footer-tab-icon">âœ¨</span>
      <span class="footer-tab-label">Ø¬Ø¯ÙŠØ¯</span>
    </button>
    <button class="footer-tab" id="tab-search" onclick="openSearchSheet()">
      <span class="footer-tab-icon">ğŸ”</span>
      <span class="footer-tab-label">Ø¨Ø­Ø«</span>
    </button>
    <div class="footer-fab" onclick="openSheet('accountSheet');renderAccountSheet();">ğŸ‘¤</div>
    <button class="footer-tab" id="tab-orders" onclick="requireAuth(function(){openOrdersSheet();})" style="position:relative;">
      <span class="footer-tab-icon">ğŸ“¦</span>
      <span class="footer-tab-label">Ø·Ù„Ø¨Ø§ØªÙŠ</span>
      <span class="footer-tab-badge" id="footerOrdersBadge" style="display:none;">0</span>
    </button>
    <button class="footer-tab" id="tab-cart" onclick="openCartSheet()">
      <span class="footer-tab-icon">ğŸ›’</span>
      <span class="footer-tab-label">Ø§Ù„Ø³Ù„Ø©</span>
      <span class="footer-tab-badge" id="footerCartBadge" style="display:none;">0</span>
    </button>
  </div>
</div>



<!-- COMPAT hidden -->
<div id="loadingPage" style="display:none"></div>
<div id="registerPage" style="display:none"></div>
<div id="loginPage" style="display:none"></div>
<div id="homePage" style="display:none"></div>
<div id="activatePage" style="display:none"></div>
<div id="checkPage" style="display:none"></div>
<div id="myOrdersPage" style="display:none"></div>
<div id="pricesPage" style="display:none"><input type="text" id="searchInput"><div id="brandsSection"><div id="brandsGrid"></div></div><div id="brandPrices"><div id="brandPricesBox"></div></div><h3 id="pricesTitle"></h3></div>
<div id="cartPage" style="display:none"></div>
<button id="backToTopBtn" style="display:none;" onclick="backToBrands()"></button>

<script>
let cart = [];

function sanitize(str) {
  if (!str) return '';
  return String(str)
    .replace(/&/g, '&amp;')
    .replace(/</g, '&lt;')
    .replace(/>/g, '&gt;')
    .replace(/"/g, '&quot;')
    .replace(/'/g, '&#39;');
}

var _productCache = {};
function cacheProduct(p) {
  var pid = 'p_' + Math.random().toString(36).substr(2,9);
  _productCache[pid] = p;
  return pid;
}
function getCachedProduct(pid) {
  return _productCache[pid] || null;
}
// â•â•â• CORE FUNCTIONS â€” LOADED FIRST â•â•â•

function showScreen(id) {
  ['loadingScreen','registerScreen','loginScreen','homeScreen'].forEach(s => {
    const el = document.getElementById(s);
    if (el) el.style.display = 'none';
  });
  const t = document.getElementById(id);
  if (t) t.style.display = 'block';
}

function requireAuth(fn) {
  var u = JSON.parse(localStorage.getItem('amwaj_user')||'null');
  if (!u) { showScreen('loginScreen'); return; }
  fn();
}

function openSheet(id) {
  const el = document.getElementById(id);
  if (el) { el.classList.add('open'); document.body.style.overflow = 'hidden'; }
}
function closeSheet(id) {
  const el = document.getElementById(id);
  if (el) { el.classList.remove('open'); document.body.style.overflow = ''; }
}
function openFlatpowerModal() {
  const m = document.getElementById('flatpowerModal');
  if (m) { m.classList.add('active'); document.body.style.overflow = 'hidden'; }
}
function closeFlatpowerModal(e) {
  if (!e || e.target === document.getElementById('flatpowerModal')) {
    const m = document.getElementById('flatpowerModal');
    if (m) m.classList.remove('active');
    document.body.style.overflow = '';
  }
}
function footerTab(tab) {
  var u = JSON.parse(localStorage.getItem('amwaj_user')||'null');
  if (!u) { showScreen('loginScreen'); return; }
  document.querySelectorAll('.footer-tab').forEach(function(t){ t.classList.remove('active'); });
  var tabEl = document.getElementById('tab-' + tab);
  if (tabEl) tabEl.classList.add('active');
  if (tab === 'home') {
    openNewItemsSheet();
  } else if (tab === 'search') {
    openSearchSheet();
  }
}
function focusHomeSearch() {
  var u = JSON.parse(localStorage.getItem('amwaj_user')||'null');
  if (!u) { showScreen('loginScreen'); return; }
  showScreen('homeScreen');
  const el = document.getElementById('globalSearch');
  if (el) { el.scrollIntoView({behavior:'smooth'}); setTimeout(()=>el.focus(), 300); }
}
function updateOrdersBadge(count) {
  ['ordersBadge','footerOrdersBadge'].forEach(id => {
    const el = document.getElementById(id);
    if (el) { el.style.display = count > 0 ? 'flex' : 'none'; el.textContent = count; }
  });
}
// renderAccountSheet â€” see clean version below



const CONFIG = {
  API_URL: "https://script.google.com/macros/s/AKfycbwHckW5szEk1Bi5s4BndOPUeO5vwd2ilMXxjYjv7WxJUeWH09H19vzl1oyUo2zf0SXDUQ/exec",
  API_KEY: "AMWAJ_d5fb3e7a-6534-4afa-8c52-b3d14b2d6d22",
  DEVICE_ID: generateDeviceId()
};

function generateDeviceId() {
  let deviceId = localStorage.getItem('amwaj_device_id');
  if (!deviceId) {
    deviceId = 'device_' + Date.now() + '_' + Math.random().toString(36).substring(7);
    localStorage.setItem('amwaj_device_id', deviceId);
  }
  return deviceId;
}

async function secureApiCall(action, data = {}) {
  try {
    const response = await fetch(CONFIG.API_URL, {
      method: 'POST',
      headers: { 'Content-Type': 'text/plain' },
      body: JSON.stringify({ apiKey: CONFIG.API_KEY, action: action, identifier: CONFIG.DEVICE_ID, ...data })
    });
    const result = await response.json();
    if (!result.success) throw new Error(result.error || 'Ø­Ø¯Ø« Ø®Ø·Ø£');
    return result.data;
  } catch (error) {
    console.error('API Error:', error);
    throw error;
  }
}

function normalizeNumber(str) {
  if (!str && str !== 0) return "";
  str = String(str);
  return str.replace(/[Ù -Ù©]/g, d => "Ù Ù¡Ù¢Ù£Ù¤Ù¥Ù¦Ù§Ù¨Ù©".indexOf(d)).replace(/[Û°-Û¹]/g, d => "Û°Û±Û²Û³Û´ÛµÛ¶Û·Û¸Û¹".indexOf(d)).replace(/\s/g, "");
}

function normalizePhone(phone) {
  let p = normalizeNumber(phone).replace(/[^0-9]/g, "");
  if (p.startsWith("964")) p = "0" + p.slice(3);
  if (p.startsWith("+964")) p = "0" + p.slice(4);
  if (p.length === 10 && !p.startsWith("0")) p = "0" + p;
  return p;
}

function extractBrand(name) {
  const nameUpper = (name || '').toUpperCase();
  const brands = {
    'GOOGLE': 'Google', 'HUAWEI': 'Huawei', 'HONOR': 'Honor', 'SAMSUNG': 'Samsung',
    'SAM': 'Samsung', 'XIAOMI': 'Xiaomi', 'REDMI': 'Redmi', 'POCO': 'Poco',
    'REALME': 'Realme', 'INFINIX': 'Infinix', 'TECNO': 'Tecno', 'OPPO': 'Oppo',
    'VIVO': 'Vivo', 'ASUS': 'Asus', 'IPHONE': 'Apple', 'IPAD': 'Apple',
    'APPLE': 'Apple', 'NOKIA': 'Nokia', 'ONEPLUS': 'OnePlus', 'NOTHING': 'Nothing',
    'SONY': 'Sony', 'LG': 'LG', 'MOTOROLA': 'Motorola', 'LENOVO': 'Lenovo',
    'ZTE': 'ZTE', 'ALCATEL': 'Alcatel', 'TCL': 'TCL', 'BLACKVIEW': 'Blackview', 'WIKO': 'Wiko'
  };
  let foundBrand = 'Ø£Ø®Ø±Ù‰', maxLength = 0;
  for (let key in brands) {
    if (nameUpper.includes(key) && key.length > maxLength) { foundBrand = brands[key]; maxLength = key.length; }
  }
  return foundBrand;
}

function openFlatpowerModal() {
  document.getElementById('flatpowerModal').classList.add('active');
  document.body.style.overflow = 'hidden';
}

function closeFlatpowerModal(event) {
  if (!event || event.target === document.getElementById('flatpowerModal')) {
    document.getElementById('flatpowerModal').classList.remove('active');
    document.body.style.overflow = '';
  }
}

function openLensFromModal() {
  document.getElementById('flatpowerModal').classList.remove('active');
  document.body.style.overflow = '';
  openPrices('lens');
}

function getFlatSubData(subType) {
  switch(subType) {
    case 'FLAT POWER':   return flatpowerData.filter(i => i.name.toUpperCase().includes('FLAT POWER'));
    case 'FLAT VOLUME':  return flatpowerData.filter(i => i.name.toUpperCase().includes('FLAT VOLUME'));
    case 'BUZZER':       return buzzerData;
    case 'EAR SPEAKER':  return earSpeakerData;
    case 'DOOR SIM':     return doorSimData;
    case 'FINGERPRINT':  return fingerprintData;
    case 'CAMERA':       return cameraData;
    case 'OTHER':        return miscData;
    default: return [];
  }
}

function openFlatSub(subType, labelAr, icon) {
  openFlatSubSheet(subType, labelAr, icon); return;
  document.getElementById("pricesTitle").innerHTML = `${icon} ${labelAr}`;
  document.getElementById("brandsSection").style.display = "block";
  document.getElementById("brandPrices").style.display = "none";
  renderBrandsGrid('flatpower');
  const searchInput = document.getElementById("searchInput");
  searchInput.value = "";
  searchInput.oninput = function() {
    const q = this.value.trim().toLowerCase();
    if (q.length < 2) { document.getElementById("brandsSection").style.display = "block"; document.getElementById("brandPrices").style.display = "none"; return; }
    document.getElementById("brandsSection").style.display = "none";
    document.getElementById("brandPrices").style.display = "block";
    const box = document.getElementById("brandPricesBox");
    box.innerHTML = `<div style="text-align:center;padding:40px 20px;"><div class="loading-spinner"></div></div>`;
    setTimeout(() => {
      const data = getFlatSubData(subType);
      const filtered = data.filter(p => (p.name && p.name.toLowerCase().includes(q)) || (p.brand && p.brand.toLowerCase().includes(q)));
      box.innerHTML = `<h3 style="color:#1e88e5;margin:10px 0;">Ù†ØªØ§Ø¦Ø¬: "${q}" - ${labelAr}</h3>`;
      if (filtered.length === 0) { box.innerHTML += "<div style='padding:10px;color:#666;'>Ù„Ø§ ØªÙˆØ¬Ø¯ Ù†ØªØ§Ø¦Ø¬</div>"; return; }
      filtered.slice(0, 50).forEach(p => { box.innerHTML += createPriceItem(p); });
      if (filtered.length > 50) box.innerHTML += `<div style="padding:10px;color:#666;text-align:center;">... Ùˆ ${filtered.length - 50} Ù†ØªÙŠØ¬Ø© Ø£Ø®Ø±Ù‰</div>`;
    }, 300);
  };
}

let currentFlatSubType = null;

function showPage(pageId) {
  ["loadingPage","registerPage","loginPage","homePage","activatePage","checkPage","pricesPage","cartPage"].forEach(p => {
    const el = document.getElementById(p);
    if (el) el.style.display = "none";
  });
  const target = document.getElementById(pageId);
  if (target) target.style.display = pageId === "loadingPage" ? "flex" : "block";
}

function showRegisterPage() { showPage("registerPage"); }
function showLoginPage() { showPage("loginPage"); }
function backHome() { showPage("homePage"); }
function openAct() { openSheet("warrantySheet"); document.getElementById("start").value = formatDate(new Date()); }
function openChk() { openSheet("checkSheet"); }

let currentPriceType = 'screens';

function openPrices(type) {
  currentPriceType = type;
  currentFlatSubType = null;
  showPage("pricesPage");
  showBackButton();
  const title = document.getElementById("pricesTitle");
  if (type === 'batteries') title.innerHTML = "ğŸ”‹ Ø§Ù„Ø¨Ø·Ø§Ø±ÙŠØ§Øª";
  else if (type === 'chargeboards') title.innerHTML = "ğŸ”Œ Ø¨ÙˆØ±Ø¯ Ø´Ø­Ù†";
  else if (type === 'flatcharging') title.innerHTML = "âš¡ Ø´Ø±ÙŠØ· Ø´Ø­Ù† + Ø´Ø§Ø´Ø©";
  else if (type === 'backcover') title.innerHTML = "ğŸ“± Ø¨Ø§Ùƒ ÙƒÙØ±";
  else if (type === 'housing') title.innerHTML = "ğŸ  Ø´Ø§ØµÙŠ";
  else if (type === 'lens') title.innerHTML = "ğŸ“· Ø¹Ø¯Ø³Ø© ÙƒØ§Ù…ÙŠØ±Ø§";
  else if (type === 'camera') title.innerHTML = "ğŸ“¸ ÙƒØ§Ù…ÙŠØ±Ø§";
  else title.innerHTML = "ğŸ–¥ï¸ Ø§Ù„Ø´Ø§Ø´Ø§Øª";
  document.getElementById("brandsSection").style.display = "block";
  document.getElementById("brandPrices").style.display = "none";
  renderBrandsGrid(type);
  const searchInput = document.getElementById("searchInput");
  searchInput.value = "";
  searchInput.oninput = function() {
    const q = this.value.trim().toLowerCase();
    if (q.length < 2) { document.getElementById("brandsSection").style.display = "block"; document.getElementById("brandPrices").style.display = "none"; return; }
    document.getElementById("brandsSection").style.display = "none";
    document.getElementById("brandPrices").style.display = "block";
    const box = document.getElementById("brandPricesBox");
    box.innerHTML = `<div style="text-align:center;padding:40px 20px;"><div class="loading-spinner"></div><div style="color:#1e88e5;font-size:16px;margin-top:15px;">Ø¬Ø§Ø±ÙŠ Ø§Ù„Ø¨Ø­Ø«...</div></div>`;
    setTimeout(() => {
      const dataToSearch = getDataForType(type);
      if (dataToSearch.length === 0) { box.innerHTML = `<div style="text-align:center;padding:40px 20px;color:#666;">Ø¬Ø§Ø±ÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø£Ø³Ø¹Ø§Ø±...</div>`; return; }
      box.innerHTML = `<h3 style="color:#1e88e5;margin:10px 0;">Ù†ØªØ§Ø¦Ø¬ Ø§Ù„Ø¨Ø­Ø«: "${q}"</h3>`;
      const filtered = dataToSearch.filter(p => (p.name && p.name.toLowerCase().includes(q)) || (p.brand && p.brand.toLowerCase().includes(q)));
      if (filtered.length === 0) { box.innerHTML += "<div style='padding:10px;color:#666;'>Ù„Ø§ ØªÙˆØ¬Ø¯ Ù†ØªØ§Ø¦Ø¬</div>"; return; }
      filtered.slice(0, 50).forEach(p => { box.innerHTML += createPriceItem(p); });
      if (filtered.length > 50) box.innerHTML += `<div style="padding:10px;color:#666;text-align:center;">... Ùˆ ${filtered.length - 50} Ù†ØªÙŠØ¬Ø© Ø£Ø®Ø±Ù‰</div>`;
    }, 300);
  };
}

function getDataForType(type) {
  switch(type) {
    case 'batteries': return batteriesData;
    case 'chargeboards': return chargeboardsData;
    case 'flatcharging': return flatchargingData;
    case 'flatpower': return flatpowerData;
    case 'backcover': return backcoverData;
    case 'housing': return housingData;
    case 'lens': return lensData;
    case 'camera': return cameraData;
    default: return pricesData;
  }
}

function renderBrandsGrid(type) {
  const grid = document.getElementById("brandsGrid");
  const commonBrands = `
    <div class="brand" data-brand="Huawei,Honor" onclick="openBrand(this)">Ù‡ÙˆØ§ÙˆÙŠ + Ù‡ÙˆÙ†Ø±<small>Huawei â€¢ Honor</small></div>
    <div class="brand" data-brand="Samsung" onclick="openBrand(this)">Ø³Ø§Ù…Ø³ÙˆÙ†Ø¬<small>Samsung</small></div>
    <div class="brand" data-brand="Apple" onclick="openBrand(this)">Ø§ÙŠÙÙˆÙ†<small>Apple</small></div>
    <div class="brand" data-brand="Xiaomi,Redmi,Poco" onclick="openBrand(this)">Ø´Ø§ÙˆÙ…ÙŠ + Ø±ÙŠØ¯Ù…ÙŠ + Ø¨ÙˆÙƒÙˆ<small>Xiaomi â€¢ Redmi â€¢ Poco</small></div>
    <div class="brand" data-brand="Oppo,Realme" onclick="openBrand(this)">Ø§ÙˆØ¨Ùˆ + Ø±ÙŠÙ„Ù…ÙŠ<small>Oppo â€¢ Realme</small></div>
    <div class="brand" data-brand="Infinix,Tecno" onclick="openBrand(this)">Ø§Ù†ÙÙ†ÙƒØ³ + ØªÙƒÙ†Ùˆ<small>Infinix â€¢ Tecno</small></div>
    <div class="brand" data-brand="Vivo" onclick="openBrand(this)">ÙÙŠÙÙˆ<small>Vivo</small></div>
  `;
  if (type === 'screens') {
    grid.innerHTML = `
      <div class="brand" data-brand="Apple" onclick="openBrand(this)">Ø§ÙŠÙÙˆÙ†<small>iPhone</small></div>
      <div class="brand" data-brand="Samsung" onclick="openBrand(this)">Ø³Ø§Ù…Ø³ÙˆÙ†Ø¬<small>Samsung</small></div>
      <div class="brand" data-brand="Huawei" onclick="openBrand(this)">Ù‡ÙˆØ§ÙˆÙŠ<small>Huawei</small></div>
      <div class="brand" data-brand="Xiaomi" onclick="openBrand(this)">Ø´Ø§ÙˆÙ…ÙŠ<small>Xiaomi</small></div>
      <div class="brand" data-brand="Redmi,Poco" onclick="openBrand(this)">Ø±ÙŠØ¯Ù…ÙŠ + Ø¨ÙˆÙƒÙˆ<small>Redmi & Poco</small></div>
      <div class="brand" data-brand="Infinix,Tecno" onclick="openBrand(this)">Ø§Ù†ÙÙ†ÙƒØ³ + ØªÙƒÙ†Ùˆ<small>Infinix & Tecno</small></div>
      <div class="brand" data-brand="Oppo,Realme" onclick="openBrand(this)">Ø§ÙˆØ¨Ùˆ + Ø±ÙŠÙ„Ù…ÙŠ<small>Oppo & Realme</small></div>
      <div class="brand" data-brand="Vivo,Wiko" onclick="openBrand(this)">ÙÙŠÙÙˆ + ÙˆÙŠÙƒÙˆ<small>Vivo & Wiko</small></div>
      <div class="brand" data-brand="Asus,RedMagic,Google" onclick="openBrand(this)">Ø§Ø²ÙˆØ² + Ø±ÙŠØ¯ Ù…Ø§Ø¬Ùƒ + ÙƒÙˆÙƒÙ„<small>Asus â€¢ RedMagic â€¢ Google</small></div>
      <div class="brand" data-brand="ZTE,Alcatel,TCL,Blackview" onclick="openBrand(this)">ZTE + Alcatel + TCL<small>ZTE â€¢ Alcatel â€¢ TCL â€¢ Blackview</small></div>
    `;
  } else if (type === 'chargeboards') {
    grid.innerHTML = commonBrands + `<div class="brand" data-brand="Asus,Google,Blackview" onclick="openBrand(this)">Ø§Ø²ÙˆØ² + ÙƒÙˆÙƒÙ„ + Ø¨Ù„Ø§Ùƒ ÙÙŠÙˆ<small>Asus â€¢ Google â€¢ Blackview</small></div>`;
  } else if (type === 'camera') {
    grid.innerHTML = commonBrands + `<div class="brand" data-brand="Asus,Google,Blackview" onclick="openBrand(this)">Ø§Ø²ÙˆØ² + ÙƒÙˆÙƒÙ„<small>Asus â€¢ Google â€¢ Blackview</small></div>`;
  } else {
    grid.innerHTML = commonBrands + `<div class="brand" data-brand="Asus,Google" onclick="openBrand(this)">Ø§Ø²ÙˆØ² + ÙƒÙˆÙƒÙ„<small>Asus â€¢ Google</small></div>`;
  }
}

async function submitRegistration() {
  const btn = document.getElementById("btnRegister");
  const result = document.getElementById("regResult");
  const name = document.getElementById("regName").value.trim();
  const shop = document.getElementById("regShop").value.trim();
  const phone = normalizePhone(document.getElementById("regPhone").value);
  if (!name || !shop || !phone) { result.innerHTML = '<div class="result error">âŒ ÙŠØ±Ø¬Ù‰ Ù…Ù„Ø¡ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø­Ù‚ÙˆÙ„</div>'; return; }
  if (phone.length < 11) { result.innerHTML = '<div class="result error">âŒ Ø±Ù‚Ù… Ø§Ù„Ù‡Ø§ØªÙ ØºÙŠØ± ØµØ­ÙŠØ­</div>'; return; }
  btn.disabled = true; btn.innerText = "Ø¬Ø§Ø±ÙŠ Ø§Ù„Ø¥Ø±Ø³Ø§Ù„...";
  try {
    const rows = await fetchCustomers();
    const existing = rows.find(r => normalizePhone(r.phone) === phone);
    if (existing) {
      if (existing.status === "approved") { localStorage.setItem("amwaj_phone", phone); result.innerHTML = '<div class="result success">âœ… Ø±Ù‚Ù…Ùƒ Ù…Ø³Ø¬Ù„ ÙˆÙ…ÙØ¹Ù„! ÙŠÙ…ÙƒÙ†Ùƒ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„</div>'; }
      else if (existing.status === "pending") { localStorage.setItem("amwaj_phone", phone); result.innerHTML = '<div class="result pending">â³ Ø·Ù„Ø¨Ùƒ Ù‚ÙŠØ¯ Ø§Ù„Ù…Ø±Ø§Ø¬Ø¹Ø©ØŒ Ø§Ù†ØªØ¸Ø± Ø§Ù„Ù…ÙˆØ§ÙÙ‚Ø©</div>'; }
      else { result.innerHTML = '<div class="result error">âŒ ØªÙ… Ø±ÙØ¶ Ø·Ù„Ø¨Ùƒ Ø³Ø§Ø¨Ù‚Ø§Ù‹ØŒ ØªÙˆØ§ØµÙ„ Ù…Ø¹Ù†Ø§ Ù„Ù„Ù…Ø²ÙŠØ¯</div>'; }
      btn.disabled = false; btn.innerText = "Ø¥Ø±Ø³Ø§Ù„ Ø·Ù„Ø¨ Ø§Ù„ØªØ³Ø¬ÙŠÙ„"; return;
    }
    await secureApiCall('addCustomer', { name, shop, phone, date: formatDate(new Date()), status: 'pending' });
    localStorage.setItem("amwaj_phone", phone);
    result.innerHTML = `<div class="result success">âœ… ØªÙ… Ø¥Ø±Ø³Ø§Ù„ Ø·Ù„Ø¨Ùƒ Ø¨Ù†Ø¬Ø§Ø­!<br>Ø³ÙŠØªÙ… Ù…Ø±Ø§Ø¬Ø¹ØªÙ‡ ÙˆØ§Ù„Ø±Ø¯ Ø¹Ù„ÙŠÙƒ Ù‚Ø±ÙŠØ¨Ø§Ù‹<br>ğŸ“± Ø±Ù‚Ù…Ùƒ: <b>${phone}</b></div>`;
    document.getElementById("regName").value = ""; document.getElementById("regShop").value = ""; document.getElementById("regPhone").value = "";
  } catch (e) { console.error(e); result.innerHTML = '<div class="result error">âŒ Ø­Ø¯Ø« Ø®Ø·Ø£ØŒ Ø­Ø§ÙˆÙ„ Ù…Ø±Ø© Ø£Ø®Ø±Ù‰</div>'; }
  btn.disabled = false; btn.innerText = "Ø¥Ø±Ø³Ø§Ù„ Ø·Ù„Ø¨ Ø§Ù„ØªØ³Ø¬ÙŠÙ„";
}

async function checkLogin() {
  const result = document.getElementById("loginResult");
  const phone = normalizePhone(document.getElementById("loginPhone").value);
  if (!phone || phone.length < 11) { result.innerHTML = '<div class="result error">âŒ Ø£Ø¯Ø®Ù„ Ø±Ù‚Ù… Ù‡Ø§ØªÙ ØµØ­ÙŠØ­</div>'; return; }
  showPage("loadingPage");
  const timeoutId = setTimeout(() => { showPage("loginPage"); result.innerHTML = '<div class="result error">âŒ Ø§Ù†ØªÙ‡Øª Ø§Ù„Ù…Ù‡Ù„Ø©ØŒ Ø­Ø§ÙˆÙ„ Ù…Ø±Ø© Ø£Ø®Ø±Ù‰</div>'; }, 10000);
  try {
    const rows = await fetchCustomers(); clearTimeout(timeoutId);
    const user = rows.find(r => normalizePhone(r.phone) === phone);
    if (!user) { showPage("loginPage"); result.innerHTML = '<div class="result error">âŒ Ø±Ù‚Ù… Ø§Ù„Ù‡Ø§ØªÙ ØºÙŠØ± Ù…Ø³Ø¬Ù„<br>Ø³Ø¬Ù„ Ø­Ø³Ø§Ø¨ Ø¬Ø¯ÙŠØ¯ Ø£ÙˆÙ„Ø§Ù‹</div>'; }
    else if (user.status === "approved") { localStorage.setItem("amwaj_user", JSON.stringify(user)); localStorage.setItem("amwaj_phone", phone); const _sw = document.getElementById("storeWelcome"); if(_sw) _sw.textContent = "Ø£Ù‡Ù„Ø§Ù‹ " + user.name.split(" ")[0] + " ğŸ‘‹"; showScreen("homeScreen"); result.innerHTML = ""; }
    else if (user.status === "pending") { localStorage.setItem("amwaj_phone", phone); showPage("loginPage"); result.innerHTML = '<div class="result pending">â³ Ø·Ù„Ø¨Ùƒ Ù‚ÙŠØ¯ Ø§Ù„Ù…Ø±Ø§Ø¬Ø¹Ø©<br>Ø§Ù†ØªØ¸Ø± Ø§Ù„Ù…ÙˆØ§ÙÙ‚Ø© ÙˆØ­Ø§ÙˆÙ„ Ù„Ø§Ø­Ù‚Ø§Ù‹</div>'; }
    else { showPage("loginPage"); result.innerHTML = '<div class="result error">âŒ ØªÙ… Ø±ÙØ¶ Ø·Ù„Ø¨Ùƒ<br>ØªÙˆØ§ØµÙ„ Ù…Ø¹Ù†Ø§ Ù„Ù„Ù…Ø²ÙŠØ¯ Ù…Ù† Ø§Ù„Ù…Ø¹Ù„ÙˆÙ…Ø§Øª</div>'; }
  } catch (e) { clearTimeout(timeoutId); console.error(e); showPage("loginPage"); result.innerHTML = '<div class="result error">âŒ Ø­Ø¯Ø« Ø®Ø·Ø£ØŒ Ø­Ø§ÙˆÙ„ Ù…Ø±Ø© Ø£Ø®Ø±Ù‰</div>'; }
}

function logout() {
  localStorage.removeItem("amwaj_user"); localStorage.removeItem("amwaj_phone"); showScreen("registerScreen");
  document.getElementById("loginPhone").value = ""; document.getElementById("loginResult").innerHTML = "";
  cart = []; saveCart(); showPage("loginPage");
}
async function fetchCustomers() { return await secureApiCall('getCustomers'); }

function handleGlobalSearch(event) {
  var u = JSON.parse(localStorage.getItem('amwaj_user')||'null');
  if (!u) { showScreen('loginScreen'); return; }
  const query = event.target.value.trim().toLowerCase();
  const resultsDiv = document.getElementById('globalSearchResults');
  if (query.length < 2) { resultsDiv.style.display = 'none'; resultsDiv.innerHTML = ''; return; }
  const allData = [
    ...pricesData.map(i => ({...i, source: 'Ø´Ø§Ø´Ø§Øª', icon: 'ğŸ–¥ï¸'})),
    ...batteriesData.map(i => ({...i, source: 'Ø¨Ø·Ø§Ø±ÙŠØ§Øª', icon: 'ğŸ”‹'})),
    ...chargeboardsData.map(i => ({...i, source: 'Ø¨ÙˆØ±Ø¯ Ø´Ø­Ù†', icon: 'ğŸ”Œ'})),
    ...flatchargingData.map(i => ({...i, source: 'Ø´Ø±ÙŠØ· Ø´Ø­Ù†', icon: 'âš¡'})),
    ...flatpowerData.map(i => ({...i, source: 'ÙÙ„Ø§Øª Ø¨ÙˆØ±/ØµÙˆØª', icon: 'ğŸ”Š'})),
    ...backcoverData.map(i => ({...i, source: 'Ø¨Ø§Ùƒ ÙƒÙØ±', icon: 'ğŸ“±'})),
    ...housingData.map(i => ({...i, source: 'Ø´Ø§ØµÙŠ', icon: 'ğŸ '})),
    ...cameraData.map(i => ({...i, source: 'ÙƒØ§Ù…ÙŠØ±Ø§', icon: 'ğŸ“·'})),
    ...buzzerData.map(i => ({...i, source: 'Ø³Ù…Ø§Ø¹Ø© Ø¬Ø±Ø³', icon: 'ğŸ””'})),
    ...earSpeakerData.map(i => ({...i, source: 'Ø³Ù…Ø§Ø¹Ø© Ø§ØªØµØ§Ù„', icon: 'ğŸ“'})),
    ...doorSimData.map(i => ({...i, source: 'Ø¨Ø§Ø¨ Ø³ÙŠÙ…', icon: 'ğŸ’³'})),
    ...fingerprintData.map(i => ({...i, source: 'Ø¨ØµÙ…Ø©', icon: 'ğŸ‘†'})),
    ...lensData.map(i => ({...i, source: 'Ø¹Ø¯Ø³Ø© ÙƒØ§Ù…ÙŠØ±Ø§', icon: 'ğŸ“·'})),
    ...miscData.map(i => ({...i, source: 'Ù…Ù†ÙˆØ¹', icon: 'ğŸ“¦'}))
  ];
  const results = allData.filter(item => (item.name && item.name.toLowerCase().includes(query)) || (item.brand && item.brand.toLowerCase().includes(query)));
  resultsDiv.style.display = 'block';
  if (results.length === 0) { resultsDiv.innerHTML = '<div style="padding:12px;color:#666;text-align:center;">Ù„Ø§ ØªÙˆØ¬Ø¯ Ù†ØªØ§Ø¦Ø¬</div>'; return; }
  let html = `<div style="font-weight:bold;color:#1e88e5;margin-bottom:8px;">Ø§Ù„Ù†ØªØ§Ø¦Ø¬ (${results.length}):</div>`;
  results.slice(0, 20).forEach(item => {
    const price = Number(String(item.price || '').replace(/[^0-9]/g, '')) || 0;
    const qty = Number(item.qty) || 0;
    const available = qty > 0 && price > 0;
    const priceText = available ? formatPriceIQD(price) + ' Ø¯.Ø¹' : 'ØºÙŠØ± Ù…ØªÙˆÙØ±';
    const priceColor = available ? '#1e88e5' : '#c62828';
    let screenTypeLabel = '';
    if (item.source === 'Ø´Ø§Ø´Ø§Øª' && item.type) {
      const typeLabels = {'Ø£ØµÙ„ÙŠ ÙˆÙƒØ§Ù„Ø©': 'ğŸŸ¢', 'Ø£ØµÙ„ÙŠ ØµÙŠÙ†ÙŠ': 'ğŸ”µ', 'TFT': 'ğŸŸ¡'};
      screenTypeLabel = `<span style="background:#e8f5e9;color:#2e7d32;padding:3px 8px;border-radius:6px;font-size:11px;font-weight:bold;margin-right:6px;display:inline-block;">${typeLabels[item.type] || ''} ${item.type}</span>`;
    }
    let notesHtml = '';
    if (item.notes && item.notes.trim()) notesHtml = `<div style="background:#fff3e0;border-right:3px solid #ff9800;padding:6px 10px;margin-top:6px;border-radius:4px;font-size:12px;color:#e65100;">ğŸ“ ${item.notes}</div>`;
    const cartBtn = available ? `<button onclick='addToCartFromSearch(${JSON.stringify(item).replace(/'/g, "&#39;")})' style="background:#25D366;color:white;padding:8px 16px;border-radius:8px;border:none;cursor:pointer;margin-top:8px;width:100%;font-weight:bold;font-size:14px;">ğŸ›’ Ø¥Ø¶Ø§ÙØ© Ù„Ù„Ø³Ù„Ø©</button>` : '';
    html += `<div style="background:#f9fbff;padding:10px;margin:6px 0;border-radius:8px;border:1px solid #e0e8f0;"><div style="font-weight:bold;font-size:14px;color:#1e3a5f;">${item.icon} ${item.name}</div><div style="font-size:12px;color:#666;margin-top:4px;">Ø§Ù„Ù‚Ø³Ù…: ${item.source} â€¢ Ø§Ù„Ù…Ø§Ø±ÙƒØ©: ${item.brand || '-'}</div>${screenTypeLabel ? `<div style="margin-top:6px;">${screenTypeLabel}</div>` : ''}${notesHtml}<div style="font-size:13px;color:${priceColor};font-weight:bold;margin-top:4px;">${priceText}</div>${cartBtn}</div>`;
  });
  if (results.length > 20) html += `<div style="padding:8px;color:#666;text-align:center;font-size:13px;">... Ùˆ ${results.length - 20} Ù†ØªÙŠØ¬Ø© Ø£Ø®Ø±Ù‰</div>`;
  resultsDiv.innerHTML = html;
}

function addToCartFromSearch(product) {
  const user = JSON.parse(localStorage.getItem('amwaj_user') || 'null');
  if (!user) { alert('ÙŠØ±Ø¬Ù‰ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ Ø£ÙˆÙ„Ø§Ù‹'); showLoginPage(); return; }
  const sourceTypeMap = {'Ø´Ø§Ø´Ø§Øª':'screens','Ø¨Ø·Ø§Ø±ÙŠØ§Øª':'batteries','Ø¨ÙˆØ±Ø¯ Ø´Ø­Ù†':'chargeboards','Ø´Ø±ÙŠØ· Ø´Ø­Ù†':'flatcharging','ÙÙ„Ø§Øª Ø¨ÙˆØ±/ØµÙˆØª':'flatpower','Ø¨Ø§Ùƒ ÙƒÙØ±':'backcover','Ø´Ø§ØµÙŠ':'housing','ÙƒØ§Ù…ÙŠØ±Ø§':'camera','Ø³Ù…Ø§Ø¹Ø© Ø¬Ø±Ø³':'flatpower','Ø³Ù…Ø§Ø¹Ø© Ø§ØªØµØ§Ù„':'flatpower','Ø¨Ø§Ø¨ Ø³ÙŠÙ…':'flatpower','Ø¨ØµÙ…Ø©':'flatpower','Ø¹Ø¯Ø³Ø© ÙƒØ§Ù…ÙŠØ±Ø§':'lens','Ù…Ù†ÙˆØ¹':'flatpower'};
  product.itemType = sourceTypeMap[product.source] || 'screens';
  addToCart(product);
}

function searchGoogle() {
  const query = document.getElementById('googleTextSearch').value.trim();
  if (!query) { alert('ÙŠØ±Ø¬Ù‰ ÙƒØªØ§Ø¨Ø© Ù†Øµ Ù„Ù„Ø¨Ø­Ø«'); return; }
  window.open(`https://www.google.com/search?q=${encodeURIComponent(query)}`, '_blank');
  document.getElementById('googleTextSearch').value = '';
}

function searchGoogleByImage(input) {
  const file = input.files[0];
  const statusDiv = document.getElementById('imageSearchStatus');
  if (!file) { statusDiv.textContent = ''; return; }
  if (!file.type.startsWith('image/')) { statusDiv.textContent = 'âŒ ÙŠØ±Ø¬Ù‰ Ø§Ø®ØªÙŠØ§Ø± ØµÙˆØ±Ø©'; return; }
  statusDiv.textContent = 'â³ Ø¬Ø§Ø±ÙŠ ØªØ­Ø¶ÙŠØ± Ø§Ù„ØµÙˆØ±Ø©...';
  const reader = new FileReader();
  reader.onload = function(e) {
    statusDiv.textContent = 'âœ… Ø§ÙØªØ­ Google Images â† Ø§Ø¶ØºØ· Ø¹Ù„Ù‰ Ø£ÙŠÙ‚ÙˆÙ†Ø© Ø§Ù„ÙƒØ§Ù…ÙŠØ±Ø§ ğŸ“· â† Ø§Ø±ÙØ¹ Ø§Ù„ØµÙˆØ±Ø©';
    window.open('https://images.google.com/', '_blank');
    input.value = '';
    setTimeout(() => { statusDiv.textContent = ''; }, 5000);
  };
  reader.onerror = function() { statusDiv.textContent = 'âŒ Ø®Ø·Ø£ ÙÙŠ Ù‚Ø±Ø§Ø¡Ø© Ø§Ù„ØµÙˆØ±Ø©'; };
  reader.readAsDataURL(file);
}

async function checkAutoLogin() {
  // Disabled â€” using appBoot() instead
}

function formatDate(d) {
  let x = new Date(d);
  return String(x.getDate()).padStart(2, '0') + "/" + String(x.getMonth() + 1).padStart(2, '0') + "/" + x.getFullYear();
}

let usedInvoices = new Set();

async function sendData() {
  const btn = document.getElementById("btnActivate");
  const result = document.getElementById("result");
  const dupMsg = document.getElementById("dupMsg");
  btn.disabled = true; btn.innerText = "Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªÙØ¹ÙŠÙ„â€¦"; dupMsg.style.display = "none";
  try {
    let name = document.getElementById("name").value.trim();
    let phone = document.getElementById("phone").value.trim();
    let screenName = document.getElementById("screenName").value.trim();
    let invoice = normalizeNumber(document.getElementById("invoice").value.trim());
    let screenCode = normalizeNumber(document.getElementById("screenCode").value).trim().toUpperCase();
    let type = document.getElementById("type").value;
    let start = document.getElementById("start").value;
    if (!name || !phone || !invoice || !screenCode) { alert("Ø£ÙƒÙ…Ù„ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø­Ù‚ÙˆÙ„"); throw "stop"; }
    if (usedInvoices.has(screenCode)) { dupMsg.innerText = "âš ï¸ ÙƒÙˆØ¯ Ø§Ù„Ø´Ø§Ø´Ø© Ù…Ø³ØªØ®Ø¯Ù… Ù…Ø³Ø¨Ù‚Ø§Ù‹"; dupMsg.style.display = "block"; throw "stop"; }
    const warranties = await secureApiCall('getWarranties');
    if (warranties.find(w => normalizeNumber(String(w.screencode || "")).trim().toUpperCase() === screenCode)) { dupMsg.innerText = "âš ï¸ ÙƒÙˆØ¯ Ø§Ù„Ø´Ø§Ø´Ø© Ù…Ø³ØªØ®Ø¯Ù… Ù…Ø³Ø¨Ù‚Ø§Ù‹"; dupMsg.style.display = "block"; throw "stop"; }
    let days = type === "screen" ? 30 : 365;
    let [d, m, y] = start.split("/");
    let end = new Date(y, m - 1, d); end.setDate(end.getDate() + days - 1);
    let remaining = Math.ceil((end - new Date()) / (1000 * 60 * 60 * 24));
    result.className = "result success"; result.style.display = "block";
    result.innerHTML = `âœ”ï¸ ØªÙ… ØªÙØ¹ÙŠÙ„ Ø§Ù„Ø¶Ù…Ø§Ù†<br>ØªØ§Ø±ÙŠØ® Ø§Ù„Ø§Ù†ØªÙ‡Ø§Ø¡: <b>${formatDate(end)}</b><br>â³ Ø§Ù„Ù…ØªØ¨Ù‚ÙŠ: <b>${remaining}</b> ÙŠÙˆÙ…<div style="margin-top:10px;padding:8px 12px;background:#fff3cd;color:#856404;border-radius:8px;font-size:14px;">âš ï¸ Ø§Ù„Ø¶Ù…Ø§Ù† Ù„Ø§ ÙŠØ´Ù…Ù„ Ø§Ù„ÙƒØ³Ø±ØŒ Ø§Ù„Ø³ÙˆØ§Ø¦Ù„ØŒ Ø£Ùˆ Ø§Ù„ØªØ±ÙƒÙŠØ¨ Ø§Ù„Ø®Ø§Ø·Ø¦<br>Ø§Ù„ÙØ§ØªÙˆØ±Ø© Ø¬Ø²Ø¡ Ù…Ù† Ø¶Ù…Ø§Ù†ÙƒÙ…ØŒ ÙŠØ±Ø¬Ù‰ Ø§Ù„Ø§Ø­ØªÙØ§Ø¸ Ø¨Ù‡Ø§</div><div style="margin-top:10px;padding:8px;background:#e3f2fd;color:#1565c0;border-radius:8px;font-size:13px;">Ø³ÙŠØªÙ… Ø¥ÙØ±Ø§Øº Ø§Ù„Ø­Ù‚ÙˆÙ„ Ø¨Ø¹Ø¯ Ù‚Ù„ÙŠÙ„...</div>`;
    await secureApiCall('addWarranty', { name, phone, invoice, screenCode, screenName, type, start, end: formatDate(end) });
    usedInvoices.add(screenCode);
    setTimeout(() => {
      document.getElementById("name").value = ""; document.getElementById("phone").value = "";
      document.getElementById("invoice").value = ""; document.getElementById("screenCode").value = "";
      document.getElementById("screenName").value = ""; document.getElementById("start").value = "";
      result.innerHTML = ""; btn.innerText = "ØªÙØ¹ÙŠÙ„ Ø§Ù„Ø¶Ù…Ø§Ù†"; btn.disabled = false;
    }, 30000);
  } catch (e) { if (e !== "stop") console.error(e); btn.innerText = "ØªÙØ¹ÙŠÙ„ Ø§Ù„Ø¶Ù…Ø§Ù†"; btn.disabled = false; }
}

async function checkWarranty() {
  let v = normalizeNumber(document.getElementById("inv").value).trim().toUpperCase();
  let out = document.getElementById("out");
  if (!v) { alert("Ø£Ø¯Ø®Ù„ ÙƒÙˆØ¯ Ø§Ù„Ø´Ø§Ø´Ø©"); return; }
  out.innerHTML = '<div class="result pending">Ø¬Ø§Ø±ÙŠ Ø§Ù„Ø¨Ø­Ø«...</div>';
  try {
    const warranties = await secureApiCall('getWarranties');
    const r = warranties.find(w => normalizeNumber(String(w.screencode || "")).trim().toUpperCase() === v);
    if (r) {
      let expiryDate = null, startDate = null;
      if (r.start_date) {
        if (typeof r.start_date === 'string' && r.start_date.includes('/')) { let [d,m,y] = r.start_date.split("/"); startDate = new Date(y,m-1,d); }
        else if (typeof r.start_date === 'number') startDate = new Date((r.start_date-25569)*86400*1000);
        else startDate = new Date(r.start_date);
      }
      if (r.expiry) {
        if (typeof r.expiry === 'string' && r.expiry.includes('/')) { let [d,m,y] = r.expiry.split("/"); expiryDate = new Date(y,m-1,d); }
        else if (typeof r.expiry === 'number') expiryDate = new Date((r.expiry-25569)*86400*1000);
        else expiryDate = new Date(r.expiry);
      }
      let remaining = expiryDate ? Math.ceil((expiryDate - new Date()) / (1000*60*60*24)) : null;
      out.innerHTML = `<div class="result ${remaining !== null && remaining >= 0 ? 'success' : 'error'}">${remaining !== null && remaining >= 0 ? 'âœ”ï¸ Ø§Ù„Ø¶Ù…Ø§Ù† Ù…ÙˆØ¬ÙˆØ¯ ÙˆØ³Ø§Ø±ÙŠ' : 'âŒ Ø§Ù„Ø¶Ù…Ø§Ù† Ù…Ù†ØªÙ‡ÙŠ'}<br>Ø§Ù„Ø§Ø³Ù…: ${r.name||"-"}<br>Ø§Ù„Ù‡Ø§ØªÙ: ${r.phone||"-"}<br>Ø§Ø³Ù… Ø§Ù„Ø´Ø§Ø´Ø©: ${r.screenname||"-"}<br>Ø§Ù„Ù†ÙˆØ¹: ${r.type||"-"}<br>ØªØ§Ø±ÙŠØ® Ø§Ù„Ø¨Ø¯Ø¡: ${startDate ? formatDate(startDate) : (r.start_date||"-")}<br>ØªØ§Ø±ÙŠØ® Ø§Ù„Ø§Ù†ØªÙ‡Ø§Ø¡: ${expiryDate ? formatDate(expiryDate) : (r.expiry||"-")}<br>${remaining !== null && remaining >= 0 ? `â³ Ø§Ù„Ø£ÙŠØ§Ù… Ø§Ù„Ù…ØªØ¨Ù‚ÙŠØ©: <b>${remaining}</b> ÙŠÙˆÙ…` : 'â›” Ø§Ù†ØªÙ‡Ù‰ Ø§Ù„Ø¶Ù…Ø§Ù† ÙˆÙ„Ø§ ÙŠÙ…ÙƒÙ† ØªØ¬Ø¯ÙŠØ¯Ù‡'}</div>`;
    } else {
      out.innerHTML = '<div class="result error">âŒ Ù„Ù… ÙŠØªÙ… Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ ÙƒÙˆØ¯ Ø§Ù„Ø´Ø§Ø´Ø©</div>';
    }
  } catch (e) { console.error(e); out.innerHTML = '<div class="result error">âŒ Ø­Ø¯Ø« Ø®Ø·Ø£: ' + e.message + '</div>'; }
}

let pricesData = [], batteriesData = [], chargeboardsData = [], flatchargingData = [];
let flatpowerData = [], backcoverData = [], housingData = [], lensData = [];
let cameraData = [], buzzerData = [], earSpeakerData = [], doorSimData = [];
let fingerprintData = [], miscData = [];

async function loadPrices() { try { pricesData = await secureApiCall('getPrices'); } catch(e){} }
async function loadBatteries() { try { const r = await secureApiCall('getBatteries'); batteriesData = r.map(i=>({...i,brand:extractBrand(i.name||i.Ø§Ù„Ø§Ø³Ù…),type:'Ø¨Ø·Ø§Ø±ÙŠØ©',name:i.name||i.Ø§Ù„Ø§Ø³Ù…||'-',price:i.price||i.Ø§Ù„Ø³Ø¹Ø±||0,qty:i.qty||i.Ø§Ù„Ø¹Ø¯Ø¯||0,notes:i.notes||i.Ù…Ù„Ø§Ø­Ø¸Ø§Øª||''})); } catch(e){} }
async function loadChargeboards() { try { const r = await secureApiCall('getChargeboards'); chargeboardsData = r.map(i=>({...i,brand:extractBrand(i.name||i.Ø§Ù„Ø§Ø³Ù…),type:'Ø¨ÙˆØ±Ø¯ Ø´Ø­Ù†',name:i.name||i.Ø§Ù„Ø§Ø³Ù…||'-',price:i.price||i.Ø§Ù„Ø³Ø¹Ø±||0,qty:i.qty||i.Ø§Ù„Ø¹Ø¯Ø¯||0,notes:i.notes||i.Ù…Ù„Ø§Ø­Ø¸Ø§Øª||''})); } catch(e){} }
async function loadFlatMain() {
  try {
    const r = await secureApiCall('getFlatMain');
    const all = r.map(i=>({...i,brand:extractBrand(i.name||i.Ø§Ù„Ø§Ø³Ù…),name:i.name||i.Ø§Ù„Ø§Ø³Ù…||'-',price:i.price||i.Ø§Ù„Ø³Ø¹Ø±||0,qty:i.qty||i.Ø§Ù„Ø¹Ø¯Ø¯||0,notes:i.notes||i.Ù…Ù„Ø§Ø­Ø¸Ø§Øª||''}));
    flatchargingData = all.filter(i=>{const n=i.name.toUpperCase();return n.includes('FLAT LCD')||n.includes('FLAT MAIN');}).map(i=>({...i,type:'Ø´Ø±ÙŠØ· Ø´Ø­Ù†/Ø´Ø§Ø´Ø©'}));
    flatpowerData = all.filter(i=>{const n=i.name.toUpperCase();return !n.includes('FLAT LCD')&&!n.includes('FLAT MAIN');}).map(i=>({...i,type:'Ø´Ø±ÙŠØ· Ø¨ÙˆØ±/ØµÙˆØª/Ù…Ù†ÙˆØ¹Ø©'}));
  } catch(e){}
}
async function loadBackCover() { try { const r = await secureApiCall('getBackCover'); backcoverData = r.map(i=>({...i,brand:extractBrand(i.name||i.Ø§Ù„Ø§Ø³Ù…),type:'Ø¨Ø§Ùƒ ÙƒÙØ±',name:i.name||i.Ø§Ù„Ø§Ø³Ù…||'-',price:i.price||i.Ø§Ù„Ø³Ø¹Ø±||0,qty:i.qty||i.Ø§Ù„Ø¹Ø¯Ø¯||0,notes:i.notes||i.Ù…Ù„Ø§Ø­Ø¸Ø§Øª||''})); } catch(e){} }
async function loadHousing() { try { const r = await secureApiCall('getHousing'); housingData = r.map(i=>({...i,brand:extractBrand(i.name||i.Ø§Ù„Ø§Ø³Ù…),type:'Ø´Ø§ØµÙŠ',name:i.name||i.Ø§Ù„Ø§Ø³Ù…||'-',price:i.price||i.Ø§Ù„Ø³Ø¹Ø±||0,qty:i.qty||i.Ø§Ù„Ø¹Ø¯Ø¯||0,notes:i.notes||i.Ù…Ù„Ø§Ø­Ø¸Ø§Øª||''})); } catch(e){} }
async function loadLens() { try { const r = await secureApiCall('getLens'); lensData = r.map(i=>({...i,brand:extractBrand(i.name||i.Ø§Ù„Ø§Ø³Ù…),type:'Ø¹Ø¯Ø³Ø© ÙƒØ§Ù…ÙŠØ±Ø§',name:i.name||i.Ø§Ù„Ø§Ø³Ù…||'-',price:i.price||i.Ø§Ù„Ø³Ø¹Ø±||0,qty:i.qty||i.Ø§Ù„Ø¹Ø¯Ø¯||0,notes:i.notes||i.Ù…Ù„Ø§Ø­Ø¸Ø§Øª||''})); } catch(e){} }
async function loadCamera() { try { const r = await secureApiCall('getCamera'); cameraData = r.map(i=>({...i,brand:extractBrand(i.name||i.Ø§Ù„Ø§Ø³Ù…),type:'ÙƒØ§Ù…ÙŠØ±Ø§',name:i.name||i.Ø§Ù„Ø§Ø³Ù…||'-',price:i.price||i.Ø§Ù„Ø³Ø¹Ø±||0,qty:i.qty||i.Ø§Ù„Ø¹Ø¯Ø¯||0,notes:i.notes||i.Ù…Ù„Ø§Ø­Ø¸Ø§Øª||''})); } catch(e){} }
async function loadBuzzer() { try { const r = await secureApiCall('getBuzzer'); buzzerData = r.map(i=>({...i,brand:extractBrand(i.name||i.Ø§Ù„Ø§Ø³Ù…),type:'Ø³Ù…Ø§Ø¹Ø© Ø¬Ø±Ø³',name:i.name||i.Ø§Ù„Ø§Ø³Ù…||'-',price:i.price||i.Ø§Ù„Ø³Ø¹Ø±||0,qty:i.qty||i.Ø§Ù„Ø¹Ø¯Ø¯||0,notes:i.notes||i.Ù…Ù„Ø§Ø­Ø¸Ø§Øª||''})); } catch(e){} }
async function loadEarSpeaker() { try { const r = await secureApiCall('getEarSpeaker'); earSpeakerData = r.map(i=>({...i,brand:extractBrand(i.name||i.Ø§Ù„Ø§Ø³Ù…),type:'Ø³Ù…Ø§Ø¹Ø© Ø§ØªØµØ§Ù„',name:i.name||i.Ø§Ù„Ø§Ø³Ù…||'-',price:i.price||i.Ø§Ù„Ø³Ø¹Ø±||0,qty:i.qty||i.Ø§Ù„Ø¹Ø¯Ø¯||0,notes:i.notes||i.Ù…Ù„Ø§Ø­Ø¸Ø§Øª||''})); } catch(e){} }
async function loadDoorSim() { try { const r = await secureApiCall('getDoorSim'); doorSimData = r.map(i=>({...i,brand:extractBrand(i.name||i.Ø§Ù„Ø§Ø³Ù…),type:'Ø¨Ø§Ø¨ Ø³ÙŠÙ… ÙƒØ§Ø±Øª',name:i.name||i.Ø§Ù„Ø§Ø³Ù…||'-',price:i.price||i.Ø§Ù„Ø³Ø¹Ø±||0,qty:i.qty||i.Ø§Ù„Ø¹Ø¯Ø¯||0,notes:i.notes||i.Ù…Ù„Ø§Ø­Ø¸Ø§Øª||''})); } catch(e){} }
async function loadFingerprint() { try { const r = await secureApiCall('getFingerprint'); fingerprintData = r.map(i=>({...i,brand:extractBrand(i.name||i.Ø§Ù„Ø§Ø³Ù…),type:'Ø¨ØµÙ…Ø©',name:i.name||i.Ø§Ù„Ø§Ø³Ù…||'-',price:i.price||i.Ø§Ù„Ø³Ø¹Ø±||0,qty:i.qty||i.Ø§Ù„Ø¹Ø¯Ø¯||0,notes:i.notes||i.Ù…Ù„Ø§Ø­Ø¸Ø§Øª||''})); } catch(e){} }
async function loadMisc() { try { const r = await secureApiCall('getMisc'); miscData = r.map(i=>({...i,brand:extractBrand(i.name||i.Ø§Ù„Ø§Ø³Ù…),type:'Ù…Ù†ÙˆØ¹',name:i.name||i.Ø§Ù„Ø§Ø³Ù…||'-',price:i.price||i.Ø§Ù„Ø³Ø¹Ø±||0,qty:i.qty||i.Ø§Ù„Ø¹Ø¯Ø¯||0,notes:i.notes||i.Ù…Ù„Ø§Ø­Ø¸Ø§Øª||''})); } catch(e){} }

function formatPriceIQD(n) {
  let priceStr = String(n || '').replace(/\s/g, '').replace(/,/g, '').replace(/\./g, '');
  return (Number(priceStr) || 0).toLocaleString("de-DE");
}

function createPriceItem(p) {
  let priceStr = String(p.price || '').replace(/\s/g, '').replace(/,/g, '').replace(/\./g, '');
  const price = Number(priceStr) || 0;
  const qty = Number(p.qty) || 0;
  const notes = p.notes || '';
  const availableText = qty > 0 && price > 0 ? `<span style="color:#1e88e5;font-weight:bold">${formatPriceIQD(price)} Ø¯.Ø¹</span>` : `<span style="color:#c62828;font-weight:bold">ØºÙŠØ± Ù…ØªÙˆÙØ±</span>`;
  const notesText = notes ? `<div style="margin-top:6px;background:#fff3cd;padding:10px 12px;border-radius:8px;font-size:15px;font-weight:600;color:#856404;border-left:4px solid #ffc107;">ğŸ“ ${notes}</div>` : '';
  const typeText = currentPriceType === 'screens' && p.type ? `<div style="margin-top:4px"><b>Ø§Ù„Ù†ÙˆØ¹:</b> ${p.type}</div>` : '';
  const cartBtn = qty > 0 && price > 0 ? `<button class="add-to-cart-btn" onclick='addToCart(${JSON.stringify(p).replace(/'/g, "&#39;")})'>ğŸ›’ Ø¥Ø¶Ø§ÙØ© Ù„Ù„Ø³Ù„Ø©</button>` : '';
  return `<div class="price-item" style="padding:12px;border:1px solid #ccc;margin:8px 0;border-radius:10px;background:#f9fbff"><div style="font-weight:bold;font-size:16px;color:#1e3a5f"><div style="margin-top:4px"><b>Ø§Ù„Ù…Ø§Ø±ÙƒØ©:</b> ${p.brand||"-"}</div><div style="margin-top:4px"><b>Ø§Ù„Ø§Ø³Ù…:</b> ${p.name||"-"}</div>${typeText}<div style="margin-top:4px"><b>Ø§Ù„Ø³Ø¹Ø±:</b> ${availableText}</div>${notesText}</div>${cartBtn}</div>`;
}

function openBrand(el) {
  const brands = el.dataset.brand.split(",").map(b => b.trim());
  document.getElementById("brandsSection").style.display = "none";
  document.getElementById("brandPrices").style.display = "block";
  const box = document.getElementById("brandPricesBox");
  showBackButton();
  box.innerHTML = `<div style="text-align:center;padding:40px 20px;"><div class="loading-spinner"></div><div style="color:#1e88e5;font-size:16px;margin-top:15px;">Ø¬Ø§Ø±ÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø£Ø³Ø¹Ø§Ø±...</div></div>`;
  const searchInput = document.getElementById("searchInput");
  searchInput.value = "";
  const checkPrices = () => {
    let dataToUse = (currentPriceType === 'flatpower' && currentFlatSubType) ? getFlatSubData(currentFlatSubType) : getDataForType(currentPriceType);
    if (dataToUse.length === 0) { setTimeout(checkPrices, 500); return; }
    box.innerHTML = `<h3 style="color:#1e88e5;margin:10px 0;">Ø£Ø³Ø¹Ø§Ø± ${brands.join(" / ")}</h3>`;
    searchInput.oninput = function() {
      const q = this.value.trim().toLowerCase();
      box.querySelectorAll(".price-item").forEach(item => { item.style.display = item.innerText.toLowerCase().includes(q) ? "block" : "none"; });
    };
    const filtered = dataToUse.filter(p => brands.map(b => b.toLowerCase()).includes((p.brand || "").toLowerCase()));
    if (filtered.length === 0) { box.innerHTML += "<div style='padding:20px;text-align:center;color:#666;'>Ù„Ø§ ØªÙˆØ¬Ø¯ Ø£Ø³Ø¹Ø§Ø±</div>"; return; }
    filtered.forEach(p => { box.innerHTML += createPriceItem(p); });
  };
  checkPrices();
}

function backToBrands() {
  document.getElementById("brandPrices").style.display = "none";
  document.getElementById("brandsSection").style.display = "block";
}

function loadCart() {
  const saved = localStorage.getItem('amwaj_cart');
  if (saved) { cart = JSON.parse(saved); updateCartBadge(); }
}

function updateCartBadge() {
  var n = (cart||[]).reduce(function(s,i){ return s+(Number(i.quantity)||1); }, 0);
  
  // Floating btn
  var cb = document.getElementById('cartBadge');
  if (cb) cb.style.display = n > 0 ? 'flex' : 'none';
  var cc = document.getElementById('cartCount');
  if (cc) cc.textContent = n;

  // Header icon badge
  var hb = document.getElementById('headerCartBadge');
  if (hb) { hb.textContent = n; hb.style.display = n > 0 ? 'flex' : 'none'; }

  // Footer tab badge
  var fb = document.getElementById('footerCartBadge');
  if (fb) { fb.textContent = n; fb.style.display = n > 0 ? 'block' : 'none'; }
}


function saveCart() { localStorage.setItem('amwaj_cart', JSON.stringify(cart)); updateCartBadge(); }


function addToCart(product) {
  const user = JSON.parse(localStorage.getItem('amwaj_user') || 'null');
  if (!user) { showScreen('loginScreen'); return; }
  if (!product.itemType) product.itemType = (typeof currentPriceType !== 'undefined') ? currentPriceType : 'screens';
  const price = Number(String(product.price || '').replace(/[^0-9]/g, '')) || 0;
  const existingIndex = cart.findIndex(function(item) {
    const itemPrice = Number(String(item.price || '').replace(/[^0-9]/g, '')) || 0;
    return item.name === product.name && itemPrice === price;
  });
  if (existingIndex !== -1) {
    cart[existingIndex].quantity = (cart[existingIndex].quantity || 1) + 1;
  } else {
    product.quantity = 1;
    cart.push(product);
  }
  saveCart();
  showCartToast(product.name || 'Ø§Ù„Ù…Ù†ØªØ¬');
}

function showCartToast(name) {
  // Remove existing toasts
  document.querySelectorAll('.cart-toast').forEach(function(t) { t.remove(); });
  
  var toast = document.createElement('div');
  toast.className = 'cart-toast';
  toast.innerHTML = '<span style="font-size:20px;">ğŸ›’</span><span>' + name + '<br><small style="opacity:.8">Ø£Ø¶ÙŠÙ Ù„Ù„Ø³Ù„Ø©</small></span>';
  toast.style.cssText = [
    'position:fixed',
    'bottom:80px',
    'left:50%',
    'transform:translateX(-50%) translateY(20px)',
    'background:#0F172A',
    'color:white',
    'padding:12px 20px',
    'border-radius:14px',
    'z-index:9999',
    'box-shadow:0 8px 24px rgba(0,0,0,0.3)',
    'display:flex',
    'align-items:center',
    'gap:10px',
    'font-family:Tajawal,sans-serif',
    'font-size:14px',
    'font-weight:700',
    'opacity:0',
    'transition:all .3s cubic-bezier(.32,.72,0,1)',
    'min-width:200px',
    'max-width:300px',
    'text-align:right',
    'direction:rtl'
  ].join(';');
  document.body.appendChild(toast);
  
  // Animate in
  requestAnimationFrame(function() {
    requestAnimationFrame(function() {
      toast.style.opacity = '1';
      toast.style.transform = 'translateX(-50%) translateY(0)';
    });
  });
  
  // Animate out
  setTimeout(function() {
    toast.style.opacity = '0';
    toast.style.transform = 'translateX(-50%) translateY(10px)';
    setTimeout(function() { toast.remove(); }, 300);
  }, 2200);
  
  // Bounce the footer cart tab
  var tab = document.getElementById('tab-cart');
  if (tab) {
    tab.style.transform = 'scale(1.3)';
    tab.style.transition = 'transform .2s';
    setTimeout(function() { tab.style.transform = 'scale(1)'; }, 200);
  }
  // Bounce header cart
  var hcart = document.querySelector('.header-icon-btn:last-child');
  if (hcart) {
    hcart.style.transform = 'scale(1.3)';
    hcart.style.transition = 'transform .2s';
    setTimeout(function() { hcart.style.transform = 'scale(1)'; }, 200);
  }
}

function removeFromCart(index) { cart.splice(index, 1); saveCart(); renderCart(); }
function clearCart() { if (confirm('Ù‡Ù„ ØªØ±ÙŠØ¯ Ø¥ÙØ±Ø§Øº Ø§Ù„Ø³Ù„Ø©ØŸ')) { cart = []; saveCart(); renderCart(); } }

function openCart() {
  const user = JSON.parse(localStorage.getItem('amwaj_user') || 'null');
  if (!user) { alert('ÙŠØ±Ø¬Ù‰ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ Ø£ÙˆÙ„Ø§Ù‹'); showLoginPage(); return; }
  showPage('cartPage'); showBackButton(); renderCart();
  document.getElementById('orderName').value = user.name || '';
  document.getElementById('orderShop').value = user.shop || '';
  const savedAddress = localStorage.getItem('amwaj_address');
  if (savedAddress) document.getElementById('orderAddress').value = savedAddress;
}

function closeCart() { showPage('pricesPage'); }

function renderCart() {
  const container = document.getElementById('cartItems');
  const totalEl = document.getElementById('cartTotal');
  const summaryDiv = document.getElementById('cartSummary');
  const orderForm = document.getElementById('orderForm');
  const clearBtn = document.getElementById('clearCartBtn');
  if (cart.length === 0) {
    container.innerHTML = '<div style="text-align:center;padding:40px;color:#666;"><div style="font-size:48px;margin-bottom:10px;">ğŸ›’</div><div>Ø§Ù„Ø³Ù„Ø© ÙØ§Ø±ØºØ©</div></div>';
    summaryDiv.style.display = 'none'; orderForm.style.display = 'none'; clearBtn.style.display = 'none'; return;
  }
  summaryDiv.style.display = 'block'; orderForm.style.display = 'block'; clearBtn.style.display = 'block';
  let total = 0; container.innerHTML = '';
  cart.forEach((item, index) => {
    const price = Number(String(item.price || '').replace(/[^0-9]/g, '')) || 0;
    const quantity = item.quantity || 1;
    const itemTotal = price * quantity;
    total += itemTotal;
    const notesHtml = item.notes ? `<div style="background:#fff3cd;padding:10px 15px;border-radius:10px;font-size:15px;color:#856404;margin-top:8px;font-weight:600;border-left:4px solid #ffc107;">ğŸ“ ${item.notes}</div>` : '';
    const warrantyChecked = item.hasWarranty ? 'checked' : '';
    const isScreen = item.itemType === 'screens';
    const warrantyBox = isScreen ? `<div style="margin-top:8px;"><div style="display:flex;align-items:center;gap:8px;padding:8px;background:#e8f5e9;border-radius:8px;"><input type="checkbox" id="warranty_${index}" ${warrantyChecked} onchange="toggleWarranty(${index})" style="width:20px;height:20px;cursor:pointer;"><label for="warranty_${index}" style="font-size:15px;font-weight:600;color:#2e7d32;cursor:pointer;margin:0;">Ù…Ø¹ Ø¶Ù…Ø§Ù† ğŸ›¡ï¸</label></div><div id="warrantyNote_${index}" style="display:${warrantyChecked ? 'block' : 'none'};background:#fff3cd;padding:10px 12px;border-radius:8px;font-size:14px;color:#856404;margin-top:8px;border-left:4px solid #ffc107;">âš ï¸ Ø¹Ù„Ù…Ø§ Ø§Ù† Ø³Ø¹Ø± Ø§Ù„Ø´Ø§Ø´Ø© ÙŠØªØºÙŠØ± Ø¹Ù†Ø¯ Ø·Ù„Ø¨ Ø§Ù„Ø¶Ù…Ø§Ù†</div></div>` : '';
    const div = document.createElement('div');
    div.className = 'cart-item';
    div.innerHTML = `<div class="cart-item-info"><div style="font-weight:bold;font-size:15px;">${item.name||'-'}</div><div style="font-size:13px;color:#000;margin-top:2px;font-weight:bold;">${item.brand||'-'}</div>${item.itemType==='screens'&&item.type?`<div style="font-size:12px;color:#000;margin-top:2px;font-weight:bold;">Ø§Ù„Ù†ÙˆØ¹: ${item.type}</div>`:''}<div style="color:#1e88e5;font-weight:bold;margin-top:4px;font-size:14px;">Ø§Ù„Ø³Ø¹Ø±: ${formatPriceIQD(price)} Ø¯.Ø¹</div>${notesHtml}${warrantyBox}<div style="display:flex;flex-direction:column;gap:8px;margin-top:10px;"><div style="display:flex;align-items:center;justify-content:space-between;"><span style="font-size:15px;font-weight:bold;color:#333;">Ø§Ù„Ø¹Ø¯Ø¯: ${quantity}</span><div style="display:flex;align-items:center;gap:6px;"><button onclick="changeQuantity(${index},-1)" style="background:#ff9800;color:white;border:none;padding:6px 10px;border-radius:5px;cursor:pointer;font-size:18px;font-weight:bold;min-width:35px;">â–</button><button onclick="changeQuantity(${index},1)" style="background:#4caf50;color:white;border:none;padding:6px 10px;border-radius:5px;cursor:pointer;font-size:18px;font-weight:bold;min-width:35px;">â•</button></div></div><div style="color:#1e88e5;font-weight:bold;font-size:15px;">Ø§Ù„Ù…Ø¬Ù…ÙˆØ¹: ${formatPriceIQD(itemTotal)} Ø¯.Ø¹</div></div><button onclick="removeFromCart(${index})" style="background:#f44336;color:white;border:none;padding:8px 20px;border-radius:8px;cursor:pointer;font-size:14px;font-weight:bold;margin-top:10px;width:auto;box-shadow:0 2px 8px rgba(244,67,54,0.4);">Ø­Ø°Ù</button></div>`;
    container.appendChild(div);
  });
  totalEl.textContent = formatPriceIQD(total) + ' Ø¯.Ø¹';
}

function changeQuantity(index, change) {
  if (!cart[index]) return;
  const newQty = (cart[index].quantity || 1) + change;
  if (newQty < 1) { if (confirm('Ù‡Ù„ ØªØ±ÙŠØ¯ Ø­Ø°Ù Ù‡Ø°Ø§ Ø§Ù„Ù…Ù†ØªØ¬ØŸ')) { removeFromCart(index); } return; }
  if (newQty > 99) { alert('Ø§Ù„Ø­Ø¯ Ø§Ù„Ø£Ù‚ØµÙ‰ 99 Ù‚Ø·Ø¹Ø©'); return; }
  cart[index].quantity = newQty; saveCart(); renderCart();
}

function toggleWarranty(index) {
  if (!cart[index]) return;
  const checkbox = document.getElementById(`warranty_${index}`);
  const note = document.getElementById(`warrantyNote_${index}`);
  cart[index].hasWarranty = checkbox.checked;
  if (note) note.style.display = checkbox.checked ? 'block' : 'none';
  saveCart();
}

async function submitOrder() {
  const user = JSON.parse(localStorage.getItem('amwaj_user') || 'null');
  if (!user) { alert('ÙŠØ±Ø¬Ù‰ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„'); return; }
  const name = document.getElementById('orderName').value.trim();
  const shop = document.getElementById('orderShop').value.trim();
  const address = document.getElementById('orderAddress').value.trim();
  const result = document.getElementById('orderResult');
  if (!name || !shop || !address) { result.innerHTML = '<div class="result error">âŒ ÙŠØ±Ø¬Ù‰ Ù…Ù„Ø¡ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø­Ù‚ÙˆÙ„</div>'; return; }
  if (cart.length === 0) { result.innerHTML = '<div class="result error">âŒ Ø§Ù„Ø³Ù„Ø© ÙØ§Ø±ØºØ©</div>'; return; }
  const submitBtn = document.querySelector('#orderForm button[onclick="submitOrder()"]');
  const clearBtn = document.getElementById('clearCartBtn');
  submitBtn.disabled = true; if (clearBtn) clearBtn.disabled = true;
  localStorage.setItem('amwaj_address', address);
  let message = `ğŸ›’ *Ø·Ù„Ø¨ Ø´Ø±Ø§Ø¡ Ø¬Ø¯ÙŠØ¯*\n\nğŸ‘¤ *Ø§Ù„Ø§Ø³Ù…:* ${name}\nğŸª *Ø§Ù„Ù…Ø­Ù„:* ${shop}\nğŸ“± *Ø§Ù„Ù‡Ø§ØªÙ:* ${user.phone}\nğŸ“ *Ø§Ù„Ø¹Ù†ÙˆØ§Ù†:* ${address}\n\n*Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª Ø§Ù„Ù…Ø·Ù„ÙˆØ¨Ø©:*\n`;
  let total = 0;
  cart.forEach((item, i) => {
    const price = Number(String(item.price || '').replace(/[^0-9]/g, '')) || 0;
    const quantity = item.quantity || 1;
    const itemTotal = price * quantity;
    total += itemTotal;
    const isScreen = item.itemType === 'screens';
    message += `${i+1}. ${item.name} (${item.brand})\n   Ø§Ù„Ù†ÙˆØ¹: ${item.type||'-'}\n   Ø§Ù„Ø³Ø¹Ø±: ${formatPriceIQD(price)} Ø¯.Ø¹\n   Ø§Ù„ÙƒÙ…ÙŠØ©: ${quantity}\n`;
    if (isScreen) message += item.hasWarranty ? `   âœ… Ù…Ø¹ Ø¶Ù…Ø§Ù† ğŸ›¡ï¸ (Ø§Ù„Ø³Ø¹Ø± ÙŠØªØºÙŠØ±)\n` : `   âšª Ø¨Ø¯ÙˆÙ† Ø¶Ù…Ø§Ù†\n`;
    message += `   Ø§Ù„Ù…Ø¬Ù…ÙˆØ¹: ${formatPriceIQD(itemTotal)} Ø¯.Ø¹\n`;
    if (item.notes) message += `   ğŸ“ Ù…Ù„Ø§Ø­Ø¸Ø©: ${item.notes}\n`;
  });
  message += `\nğŸ’° *Ø§Ù„Ù…Ø¬Ù…ÙˆØ¹ Ø§Ù„ÙƒÙ„ÙŠ:* ${formatPriceIQD(total)} Ø¯.Ø¹`;
  result.innerHTML = '<div class="result pending">Ø¬Ø§Ø±ÙŠ Ø§Ù„Ø¥Ø±Ø³Ø§Ù„...</div>';
  try {
    const response = await fetch('https://api.greenapi.com/waInstance7103498677/sendMessage/9c30040e79424fd1afc33d7283cd3000d01f88d037204a3f9c', {
      method: 'POST', headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ chatId: '9647709000160@c.us', message: message })
    });
    const data = await response.json();
    if (data.idMessage) {
      try { await secureApiCall('saveOrder', { name, shop, phone: user.phone, address, items: cart, total }); } catch(e) {}
      result.innerHTML = '<div class="result success">âœ… ØªÙ… Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø·Ù„Ø¨ Ø¨Ù†Ø¬Ø§Ø­!<br>Ø³ÙŠØªÙ… ØªØ¬Ù‡ÙŠØ²Ù‡Ø§ Ù‚Ø±ÙŠØ¨Ø§Ù‹ ğŸ“¦</div>';
      let customerMessage = `âœ… *ØªÙ… Ø§Ø³ØªÙ„Ø§Ù… Ø·Ù„Ø¨Ùƒ Ø¨Ù†Ø¬Ø§Ø­*\n\nÙ…Ø±Ø­Ø¨Ø§Ù‹ *${name}*ØŒ\n\nØ´ÙƒØ±Ø§Ù‹ Ù„Ø·Ù„Ø¨Ùƒ Ù…Ù† Ø£Ù…ÙˆØ§Ø¬ Ù„Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠØ§Øª ğŸŒŠ\n\nğŸ“‹ *ØªÙØ§ØµÙŠÙ„ Ø·Ù„Ø¨Ùƒ:*\n\n`;
      cart.forEach((item, i) => {
        const price = Number(String(item.price || '').replace(/[^0-9]/g, '')) || 0;
        const quantity = item.quantity || 1;
        const itemTotal = price * quantity;
        const isScreen = item.itemType === 'screens';
        customerMessage += `${i+1}. ${item.name}\n   Ø§Ù„Ù…Ø§Ø±ÙƒØ©: ${item.brand}\n   Ø§Ù„Ù†ÙˆØ¹: ${item.type||'-'}\n   Ø§Ù„Ø³Ø¹Ø±: ${formatPriceIQD(price)} Ø¯.Ø¹\n   Ø§Ù„ÙƒÙ…ÙŠØ©: ${quantity}\n`;
        if (isScreen) customerMessage += item.hasWarranty ? `   âœ… Ù…Ø¹ Ø¶Ù…Ø§Ù† ğŸ›¡ï¸ (Ø§Ù„Ø³Ø¹Ø± ÙŠØªØºÙŠØ±)\n` : `   âšª Ø¨Ø¯ÙˆÙ† Ø¶Ù…Ø§Ù†\n`;
        customerMessage += `   Ø§Ù„Ù…Ø¬Ù…ÙˆØ¹: ${formatPriceIQD(itemTotal)} Ø¯.Ø¹\n`;
        if (item.notes) customerMessage += `   ğŸ“ ${item.notes}\n`;
        customerMessage += `\n`;
      });
      customerMessage += `ğŸ’° *Ø§Ù„Ù…Ø¬Ù…ÙˆØ¹ Ø§Ù„ÙƒÙ„ÙŠ:* ${formatPriceIQD(total)} Ø¯.Ø¹\n\nğŸ“ *Ø¹Ù†ÙˆØ§Ù† Ø§Ù„ØªÙˆØµÙŠÙ„:* ${address}\n\nÙ„Ù„Ø§Ø³ØªÙØ³Ø§Ø±:\nğŸ“ 7696\nğŸ“ 07709000160\n\nØ´ÙƒØ±Ø§Ù‹ Ù„Ø«Ù‚ØªÙƒÙ… ğŸŒŠ\n*Ø£Ù…ÙˆØ§Ø¬ Ù„Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠØ§Øª*`;
      fetch('https://api.greenapi.com/waInstance7103498677/sendMessage/9c30040e79424fd1afc33d7283cd3000d01f88d037204a3f9c', {
        method: 'POST', headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ chatId: user.phone.replace(/^0/, '964') + '@c.us', message: customerMessage })
      }).catch(err => console.error(err));
      setTimeout(() => {
        cart = []; saveCart(); result.innerHTML = ''; submitBtn.disabled = false;
        if (clearBtn) clearBtn.disabled = false;
        if (document.getElementById('cartPage').style.display !== 'none') renderCart(); else closeCart();
      }, 20000);
    } else { throw new Error('ÙØ´Ù„ Ø§Ù„Ø¥Ø±Ø³Ø§Ù„'); }
  } catch (e) {
    console.error(e);
    result.innerHTML = '<div class="result error">âŒ Ø­Ø¯Ø« Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø¥Ø±Ø³Ø§Ù„ØŒ Ø­Ø§ÙˆÙ„ Ù…Ø±Ø© Ø£Ø®Ø±Ù‰</div>';
    submitBtn.disabled = false; if (clearBtn) clearBtn.disabled = false;
  }
}

function backToBrands() {
  const brandsSection = document.getElementById("brandsSection");
  const brandPrices = document.getElementById("brandPrices");
  const cartPage = document.getElementById("cartPage");
  const btn = document.getElementById("backToTopBtn");
  if (cartPage.style.display === "block") { showPage("homePage"); btn.style.display = "none"; }
  else if (brandPrices.style.display === "block") { brandPrices.style.display = "none"; brandsSection.style.display = "block"; window.scrollTo({ top: 0, behavior: 'smooth' }); }
  else if (brandsSection.style.display === "block") { showPage("homePage"); btn.style.display = "none"; }
}

function showBackButton() { document.getElementById("backToTopBtn").style.display = "block"; }
function hideBackButton() { document.getElementById("backToTopBtn").style.display = "none"; }

let touchStartX = 0, touchStartY = 0, touchEndX = 0, touchEndY = 0;
document.addEventListener('touchstart', function(e) { touchStartX = e.changedTouches[0].screenX; touchStartY = e.changedTouches[0].screenY; }, false);
document.addEventListener('touchend', function(e) { touchEndX = e.changedTouches[0].screenX; touchEndY = e.changedTouches[0].screenY; handleSwipe(); }, false);
function handleSwipe() {
  const diffX = touchEndX - touchStartX;
  const diffY = touchEndY - touchStartY;
  if (Math.abs(diffX) > Math.abs(diffY)) {
    if (diffX < -50) {
      const brandsSection = document.getElementById("brandsSection");
      const brandPrices = document.getElementById("brandPrices");
      const cartPage = document.getElementById("cartPage");
      if (brandPrices && brandPrices.style.display === "block") backToBrands();
      else if (brandsSection && brandsSection.style.display === "block") backToBrands();
      else if (cartPage && cartPage.style.display === "block") backToBrands();
      else if (!document.getElementById("homePage") || document.getElementById("homePage").style.display !== "block") showPage("homePage");
    }
  }
}

// â•â•â• APP SHELL FUNCTIONS â•â•â•

function showScreen(id) {
  ['loadingScreen','registerScreen','loginScreen','homeScreen'].forEach(s => {
    const el = document.getElementById(s);
    if (el) el.style.display = 'none';
  });
  const target = document.getElementById(id);
  if (target) target.style.display = (id === 'homeScreen') ? 'block' : 'block';
}

// footerTab defined above

function renderAccountSheet() {
  const user = JSON.parse(localStorage.getItem('amwaj_user') || 'null');
  const div = document.getElementById('accountContent');
  if (!div) return;
  if (user) {
    div.innerHTML =
      '<div style="background:linear-gradient(135deg,#0284C7,#0891B2);color:white;border-radius:16px;padding:20px;text-align:center;margin-bottom:16px;">' +
      '<div style="font-size:40px;margin-bottom:8px;">&#128100;</div>' +
      '<div style="font-size:18px;font-weight:800;">' + user.name + '</div>' +
      '<div style="font-size:13px;opacity:.85;margin-top:4px;">' + user.shop + '</div>' +
      '<div style="font-size:12px;opacity:.7;margin-top:2px;">' + user.phone + '</div>' +
      '</div>' +
      '<button class="form-btn" onclick="openWarrantyFromAccount()">&#9989; ØªÙØ¹ÙŠÙ„ Ø§Ù„Ø¶Ù…Ø§Ù†</button>' +
      '<button class="form-btn" style="background:#64748B;margin-top:8px;" onclick="openCheckFromAccount()">&#128269; Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„Ø¶Ù…Ø§Ù†</button>' +
      '<button class="form-btn danger" style="margin-top:12px;" onclick="logout()">&#128682; ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø®Ø±ÙˆØ¬</button>';
  } else {
    div.innerHTML =
      '<div style="text-align:center;padding:20px 0;">' +
      '<div style="font-size:48px;margin-bottom:12px;">&#128100;</div>' +
      '<div style="font-size:16px;font-weight:700;margin-bottom:6px;">ØºÙŠØ± Ù…Ø³Ø¬Ù„ Ø§Ù„Ø¯Ø®ÙˆÙ„</div>' +
      '<div style="font-size:13px;color:#64748B;margin-bottom:20px;">Ø³Ø¬Ù„ Ø¯Ø®ÙˆÙ„Ùƒ Ù„Ù„ÙˆØµÙˆÙ„ Ù„ÙƒÙ„ Ø§Ù„Ø®Ø¯Ù…Ø§Øª</div>' +
      '</div>' +
      '<button class="form-btn" onclick="toLoginScreen()">ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„</button>' +
      '<button class="form-btn success-btn" style="margin-top:8px;" onclick="toRegisterScreen()">ØªØ³Ø¬ÙŠÙ„ Ø­Ø³Ø§Ø¨ Ø¬Ø¯ÙŠØ¯</button>';
  }
}
function toLoginScreen() { closeSheet('accountSheet'); showScreen('loginScreen'); }
function toRegisterScreen() { closeSheet('accountSheet'); showScreen('registerScreen'); }

function openOrdersSheet() {
  openSheet('ordersSheet');
  loadMyOrders();
}

function openCartSheet() {
  const user = JSON.parse(localStorage.getItem('amwaj_user') || 'null');
  if (!user) { showScreen('loginScreen'); return; }
  openSheet('cartSheet');
  renderCart();
  document.getElementById('orderName').value = user.name || '';
  document.getElementById('orderShop').value = user.shop || '';
  const saved = localStorage.getItem('amwaj_address');
  if (saved) document.getElementById('orderAddress').value = saved;
}

function openCart() { openCartSheet(); }

// Override openFlatSub
function openFlatSub(subType, labelAr, icon) {
  openFlatSubSheet(subType, labelAr, icon);
}

function openLensFromModal() {
  closeFlatpowerModal();
  openProductSheet('camera', 'ğŸ“· Ø¹Ø¯Ø³Ø© ÙƒØ§Ù…ÙŠØ±Ø§');
}

// override old nav functions
function showPage(id) { /* no-op */ }
function backHome() { showScreen('homeScreen'); }
function showLoginPage() { showScreen('loginScreen'); }
function showRegisterPage() { showScreen('registerScreen'); }
function openAct() { openSheet('warrantySheet'); document.getElementById('start').value = formatDate(new Date()); }
function openChk() { openSheet('checkSheet'); }
function openMyOrders() { openOrdersSheet(); }
function showBackButton() {}
function hideBackButton() {}
function backToBrands() {}

function updateOrdersBadge(count) {
  // quick btn badge
  const qb = document.getElementById('ordersBadge');
  if (qb) { qb.style.display = count > 0 ? 'flex' : 'none'; qb.textContent = count; }
  // footer badge
  const fb = document.getElementById('footerOrdersBadge');
  if (fb) { fb.style.display = count > 0 ? 'flex' : 'none'; fb.textContent = count; }
}

// Override updateCartBadge to also update footer and header
const _origUpdateCart = window.updateCartBadge;

// App boot
// â•â•â• SHEET & PRODUCT FUNCTIONS â•â•â•

let sheetPriceType = 'screens';
let sheetFlatSubType = null;

function openProductSheet(type, title) {
  sheetPriceType = type;
  sheetFlatSubType = null;
  if (typeof currentPriceType !== 'undefined') currentPriceType = type;
  if (typeof currentFlatSubType !== 'undefined') currentFlatSubType = null;
  document.getElementById('productsSheetTitle').textContent = title;
  document.getElementById('sheetSearch').value = '';
  document.getElementById('sheetResults').innerHTML = '';
  renderSheetBrands(type);
  openSheet('productsSheet');
}

function openFlatSubSheet(subType, labelAr, icon) {
  closeFlatpowerModal();
  sheetPriceType = 'flatpower';
  sheetFlatSubType = subType;
  if (typeof currentPriceType !== 'undefined') currentPriceType = 'flatpower';
  if (typeof currentFlatSubType !== 'undefined') currentFlatSubType = subType;
  document.getElementById('productsSheetTitle').textContent = icon + ' ' + labelAr;
  document.getElementById('sheetSearch').value = '';
  document.getElementById('sheetResults').innerHTML = '';
  renderSheetBrands('flatpower');
  openSheet('productsSheet');
}

function renderSheetBrands(type) {
  const grid = document.getElementById('sheetBrands');
  const screenBrands = [
    {label:'Ø§ÙŠÙÙˆÙ†', sub:'iPhone', brands:'Apple'},
    {label:'Ø³Ø§Ù…Ø³ÙˆÙ†Ø¬', sub:'Samsung', brands:'Samsung'},
    {label:'Ù‡ÙˆØ§ÙˆÙŠ', sub:'Huawei', brands:'Huawei'},
    {label:'Ø´Ø§ÙˆÙ…ÙŠ', sub:'Xiaomi', brands:'Xiaomi'},
    {label:'Ø±ÙŠØ¯Ù…ÙŠ + Ø¨ÙˆÙƒÙˆ', sub:'Redmi & Poco', brands:'Redmi,Poco'},
    {label:'Ø§Ù†ÙÙ†ÙƒØ³ + ØªÙƒÙ†Ùˆ', sub:'Infinix & Tecno', brands:'Infinix,Tecno'},
    {label:'Ø§ÙˆØ¨Ùˆ + Ø±ÙŠÙ„Ù…ÙŠ', sub:'Oppo & Realme', brands:'Oppo,Realme'},
    {label:'ÙÙŠÙÙˆ + ÙˆÙŠÙƒÙˆ', sub:'Vivo & Wiko', brands:'Vivo,Wiko'},
    {label:'Ø§Ø²ÙˆØ² + ÙƒÙˆÙƒÙ„', sub:'Asus & Google', brands:'Asus,Google'},
    {label:'ZTE + TCL + Alcatel', sub:'ZTE â€¢ TCL â€¢ Alcatel', brands:'ZTE,TCL,Alcatel,Blackview'},
  ];
  const commonBrands = [
    {label:'Ù‡ÙˆØ§ÙˆÙŠ + Ù‡ÙˆÙ†Ø±', sub:'Huawei & Honor', brands:'Huawei,Honor'},
    {label:'Ø³Ø§Ù…Ø³ÙˆÙ†Ø¬', sub:'Samsung', brands:'Samsung'},
    {label:'Ø§ÙŠÙÙˆÙ†', sub:'Apple', brands:'Apple'},
    {label:'Ø´Ø§ÙˆÙ…ÙŠ + Ø±ÙŠØ¯Ù…ÙŠ + Ø¨ÙˆÙƒÙˆ', sub:'Xiaomi â€¢ Redmi â€¢ Poco', brands:'Xiaomi,Redmi,Poco'},
    {label:'Ø§ÙˆØ¨Ùˆ + Ø±ÙŠÙ„Ù…ÙŠ', sub:'Oppo & Realme', brands:'Oppo,Realme'},
    {label:'Ø§Ù†ÙÙ†ÙƒØ³ + ØªÙƒÙ†Ùˆ', sub:'Infinix & Tecno', brands:'Infinix,Tecno'},
    {label:'ÙÙŠÙÙˆ', sub:'Vivo', brands:'Vivo'},
    {label:'Ø§Ø²ÙˆØ² + ÙƒÙˆÙƒÙ„', sub:'Asus & Google', brands:'Asus,Google'},
  ];
  const list = type === 'screens' ? screenBrands : commonBrands;
  grid.style.display = 'grid';
  grid.innerHTML = list.map(function(b) {
    return '<div class="sheet-brand-btn" onclick="openSheetBrand(\'' + b.brands + '\')"><b>' + b.label + '</b><small>' + b.sub + '</small></div>';
  }).join('');
}

function handleSheetSearch() {
  const q = document.getElementById('sheetSearch').value.trim().toLowerCase();
  const resultsDiv = document.getElementById('sheetResults');
  const brandsDiv = document.getElementById('sheetBrands');
  if (q.length < 2) { resultsDiv.innerHTML = ''; brandsDiv.style.display = 'grid'; return; }
  brandsDiv.style.display = 'none';
  const data = sheetFlatSubType ? getFlatSubData(sheetFlatSubType) : getDataForType(sheetPriceType);
  const filtered = data.filter(function(p) { return (p.name||'').toLowerCase().includes(q) || (p.brand||'').toLowerCase().includes(q); });
  if (!filtered.length) { resultsDiv.innerHTML = '<div style="padding:20px;text-align:center;color:#64748B;">Ù„Ø§ ØªÙˆØ¬Ø¯ Ù†ØªØ§Ø¦Ø¬</div>'; return; }
  resultsDiv.innerHTML = '<div style="font-size:12px;color:#64748B;margin-bottom:8px;">' + Math.min(filtered.length,50) + ' Ù†ØªÙŠØ¬Ø©</div>' +
    filtered.slice(0,50).map(function(p) { return createSheetPriceItem(p); }).join('');
}

function openSheetBrand(brandsStr) {
  const brands = brandsStr.split(',').map(function(b) { return b.trim().toLowerCase(); });
  const data = sheetFlatSubType ? getFlatSubData(sheetFlatSubType) : getDataForType(sheetPriceType);
  const filtered = data.filter(function(p) { return brands.includes((p.brand||'').toLowerCase()); });
  const brandsDiv = document.getElementById('sheetBrands');
  const resultsDiv = document.getElementById('sheetResults');
  brandsDiv.style.display = 'none';
  if (!filtered.length) {
    resultsDiv.innerHTML = '<div style="padding:20px;text-align:center;color:#64748B;">Ù„Ø§ ØªÙˆØ¬Ø¯ Ø£Ø³Ø¹Ø§Ø±</div>';
  } else {
    resultsDiv.innerHTML =
      '<div style="display:flex;align-items:center;gap:8px;margin-bottom:10px;">' +
      '<button onclick="backToSheetBrands()" style="background:#F1F5F9;color:#0F172A;border:none;border-radius:8px;padding:7px 12px;font-family:Tajawal,sans-serif;font-size:13px;font-weight:700;cursor:pointer;width:auto;margin:0;">&#8594; Ø±Ø¬ÙˆØ¹</button>' +
      '<span style="font-size:12px;color:#64748B;">' + filtered.length + ' Ù…Ù†ØªØ¬</span>' +
      '</div>' +
      filtered.map(function(p) { return createSheetPriceItem(p); }).join('');
  }
}

function backToSheetBrands() {
  document.getElementById('sheetBrands').style.display = 'grid';
  document.getElementById('sheetResults').innerHTML = '';
  document.getElementById('sheetSearch').value = '';
}

function createSheetPriceItem(p) {
  var price = Number(String(p.price||'').replace(/[^0-9]/g,'')) || 0;
  var qty = Number(p.qty) || 0;
  var avail = qty > 0 && price > 0;
  var priceHtml = avail
    ? '<div class="pi-price avail">' + formatPriceIQD(price) + ' IQD</div>'
    : '<div class="pi-price unavail">ØºÙŠØ± Ù…ØªÙˆÙØ±</div>';
  var typeHtml = (sheetPriceType === 'screens' && p.type) ? '<span class="pi-type">' + p.type + '</span>' : '';
  var notesHtml = (p.notes && p.notes.trim()) ? '<div class="pi-notes">&#128221; ' + sanitize(p.notes) + '</div>' : '';
  var cartBtn = '';
  if (avail) {
    var pid = 'pi_' + Math.random().toString(36).substr(2,6);
    window['_pd_' + pid] = p;
    cartBtn = '<button class="add-to-cart-btn" onclick="addToCartById(\'_pd_' + pid + '\')">&#128722; Ø¥Ø¶Ø§ÙØ© Ù„Ù„Ø³Ù„Ø©</button>';
  }
  return '<div class="price-item"><div class="pi-name">' + (p.name||'-') + '</div>' +
    '<div class="pi-brand">' + (p.brand||'-') + '</div>' +
    typeHtml + priceHtml + notesHtml + cartBtn + '</div>';
}

function addToCartById(key) {
  var p = getCachedProduct(key);
  if (!p) return;
  p.itemType = sheetPriceType;
  addToCart(p);
}


// addToCartInSheet replaced by addToCartById

function loadMyOrders() {
  const user = JSON.parse(localStorage.getItem('amwaj_user') || 'null');
  const listDiv = document.getElementById('myOrdersList');
  const loadDiv = document.getElementById('myOrdersLoading');
  if (!user) {
    if (loadDiv) loadDiv.style.display = 'none';
    if (listDiv) listDiv.innerHTML = '<div style="padding:20px;text-align:center;color:#64748B;">ÙŠØ±Ø¬Ù‰ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ Ø£ÙˆÙ„Ø§Ù‹</div>';
    return;
  }
  if (loadDiv) loadDiv.style.display = 'block';
  if (listDiv) listDiv.innerHTML = '';
  secureApiCall('getMyOrders', { phone: user.phone }).then(function(orders) {
    if (loadDiv) loadDiv.style.display = 'none';
    if (!orders || !orders.length) {
      if (listDiv) listDiv.innerHTML = '<div style="padding:30px;text-align:center;color:#64748B;">&#128230; Ù„Ø§ ØªÙˆØ¬Ø¯ Ø·Ù„Ø¨Ø§Øª</div>';
      return;
    }
    var steps = ['pending','picked','delivered'];
    var stepLabels = ['ØªØ¬Ù‡ÙŠØ²','Ø§Ù„Ø·Ø±ÙŠÙ‚','ÙˆØµÙ„'];
    var stepIcons = ['&#128203;','&#128663;','&#128230;'];
    var html = orders.map(function(o) {
      var cur = steps.indexOf(o.status);
      var statusText = {pending:'Ù‚ÙŠØ¯ Ø§Ù„ØªØ¬Ù‡ÙŠØ²',picked:'ÙÙŠ Ø§Ù„Ø·Ø±ÙŠÙ‚',delivered:'ØªÙ… Ø§Ù„ØªÙˆØµÙŠÙ„',cancelled:'Ù…Ù„ØºÙŠ'}[o.status] || o.status;
      var pillClass = 'pill-' + (o.status || 'pending');
      var items = (o.items||[]).map(function(it) {
        var p2 = Number(String(it.price||'').replace(/[^0-9]/g,''))||0;
        return '<div class="order-item-row">â€¢ ' + (it.name||'-') + ' Ã— ' + (it.quantity||1) + ' â€” <span dir="ltr">' + formatPriceIQD(p2) + ' IQD</span></div>';
      }).join('');
      var total = Number(String(o.total||'').replace(/[^0-9]/g,''))||0;
      var timelineHtml = '<div class="order-status-bar">' + steps.map(function(s,i) {
        var cls = cur > i ? 'done' : (cur === i ? 'active' : '');
        return '<div class="order-step ' + cls + '"><div class="step-dot">' + stepIcons[i] + '</div><div class="step-txt">' + stepLabels[i] + '</div></div>';
      }).join('') + '</div>';
      var cancelBtn = o.status === 'pending'
        ? '<button class="cancel-order-btn" onclick="cancelOrderById(this)" data-id="' + (o.orderId||'') + '">&#10060; Ø¥Ù„ØºØ§Ø¡ Ø§Ù„Ø·Ù„Ø¨</button>' : '';
      return '<div class="order-card">' +
        '<div class="order-card-header">' +
          '<span class="order-id-text">' + (o.orderId||'-') + '</span>' +
          '<span class="status-pill ' + pillClass + '">' + statusText + '</span>' +
        '</div>' +
        timelineHtml + items +
        '<div style="font-weight:800;font-size:15px;color:#0284C7;margin-top:8px;border-top:1px solid #E2E8F0;padding-top:8px;">Ø§Ù„Ù…Ø¬Ù…ÙˆØ¹: <span dir="ltr">' + formatPriceIQD(total) + ' IQD</span></div>' +
        '<div style="font-size:12px;color:#64748B;margin-top:4px;">&#128205; ' + (o.address||'-') + '</div>' +
        cancelBtn + '</div>';
    }).join('');
    if (listDiv) listDiv.innerHTML = html;
    var active = orders.filter(function(o) { return o.status === 'pending' || o.status === 'picked'; });
    updateOrdersBadge(active.length);
  }).catch(function(e) {
    if (loadDiv) loadDiv.style.display = 'none';
    if (listDiv) listDiv.innerHTML = '<div class="result error">&#9888;&#65039; ÙØ´Ù„ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø·Ù„Ø¨Ø§Øª</div>';
  });
}

function openOrdersSheet() {
  const user = JSON.parse(localStorage.getItem('amwaj_user') || 'null');
  if (!user) { showScreen('loginScreen'); return; }
  openSheet('ordersSheet');
  loadMyOrders();
}

function openCartSheet() {
  const user = JSON.parse(localStorage.getItem('amwaj_user') || 'null');
  if (!user) { showScreen('loginScreen'); return; }
  openSheet('cartSheet');
  renderCart();
  const nameEl = document.getElementById('orderName');
  const shopEl = document.getElementById('orderShop');
  if (nameEl) nameEl.value = user.name || '';
  if (shopEl) shopEl.value = user.shop || '';
  const saved = localStorage.getItem('amwaj_address');
  if (saved) { const addrEl = document.getElementById('orderAddress'); if (addrEl) addrEl.value = saved; }
}


function cancelOrderById(btn) {
  var orderId = btn.getAttribute('data-id');
  if (!confirm('Ù‡Ù„ ØªØ±ÙŠØ¯ Ø¥Ù„ØºØ§Ø¡ Ø§Ù„Ø·Ù„Ø¨ ' + orderId + 'ØŸ')) return;
  secureApiCall('cancelOrder', { orderId: orderId })
    .then(function() { loadMyOrders(); })
    .catch(function() { alert('ÙØ´Ù„ Ø¥Ù„ØºØ§Ø¡ Ø§Ù„Ø·Ù„Ø¨'); });
}

function cancelOrder(orderId) {
  if (!confirm('Ù‡Ù„ ØªØ±ÙŠØ¯ Ø¥Ù„ØºØ§Ø¡ Ø§Ù„Ø·Ù„Ø¨ ' + orderId + 'ØŸ')) return;
  secureApiCall('cancelOrder', { orderId: orderId })
    .then(function() { loadMyOrders(); })
    .catch(function() { alert('ÙØ´Ù„ Ø¥Ù„ØºØ§Ø¡ Ø§Ù„Ø·Ù„Ø¨'); });
}

// Override old functions
function openCart() { openCartSheet(); }
function openFlatSub(subType, labelAr, icon) { openFlatSubSheet(subType, labelAr, icon); }
function openLensFromModal() { closeFlatpowerModal(); openProductSheet('camera', '&#128247; Ø¹Ø¯Ø³Ø© ÙƒØ§Ù…ÙŠØ±Ø§'); }
function showPage(id) { /* no-op */ }
function backHome() { showScreen('homeScreen'); }
function showLoginPage() { showScreen('loginScreen'); }
function showRegisterPage() { showScreen('registerScreen'); }
function openAct() { openSheet('warrantySheet'); const s = document.getElementById('start'); if(s) s.value = formatDate(new Date()); }
function openChk() { openSheet('checkSheet'); }
function openMyOrders() { openOrdersSheet(); }
function showBackButton() {}
function hideBackButton() {}
function backToBrands() {}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

// â”€â”€ Search Sheet â”€â”€
// â”€â”€ Snapshot system for "Ø¬Ø¯ÙŠØ¯" detection â”€â”€
var _prevSnapshot = null;

function saveSnapshot(allData) {
  var snap = {};
  var typeKeys = {
    screens:'s', batteries:'b', chargeboards:'c', backcover:'bc',
    housing:'h', camera:'cam', flatcharging:'fc'
  };
  Object.keys(typeKeys).forEach(function(t) {
    var data = allData[t] || [];
    data.forEach(function(p) {
      var key = typeKeys[t] + '|' + (p.name||'').trim();
      snap[key] = Number(p.qty)||0;
    });
  });
  localStorage.setItem('amwaj_snap', JSON.stringify(snap));
  localStorage.setItem('amwaj_snap_time', Date.now().toString());
}

function getPrevSnapshot() {
  try {
    var s = localStorage.getItem('amwaj_snap');
    return s ? JSON.parse(s) : {};
  } catch(e) { return {}; }
}

function isNewItem(p, type) {
  var typeKeys = {
    screens:'s', batteries:'b', chargeboards:'c', backcover:'bc',
    housing:'h', camera:'cam', flatcharging:'fc'
  };
  var snap = getPrevSnapshot();
  if (!Object.keys(snap).length) return false; // first load ever, nothing is "new"
  var key = (typeKeys[type]||type) + '|' + (p.name||'').trim();
  var prevQty = snap.hasOwnProperty(key) ? snap[key] : -1;
  // New if: didn't exist before OR was 0 and now has stock
  return prevQty === -1 || prevQty === 0;
}

function saveSnapshotAfterLoad() {
  var allData = {
    screens: pricesData||[], batteries: batteriesData||[],
    chargeboards: chargeboardsData||[], backcover: backcoverData||[],
    housing: housingData||[], camera: cameraData||[], flatcharging: flatchargingData||[]
  };
  // Only save if we have data
  var total = Object.values(allData).reduce(function(s,a){return s+a.length;},0);
  if (total > 0) saveSnapshot(allData);
}

function openNewItemsSheet() {
  var u = JSON.parse(localStorage.getItem('amwaj_user')||'null');
  if (!u) { showScreen('loginScreen'); return; }
  openSheet('newItemsSheet');
  var body = document.getElementById('newItemsSheetBody');
  body.innerHTML = '<div style="text-align:center;padding:30px;"><div class="loading-spinner" style="margin:0 auto;"></div></div>';

  var allTypes = ['screens','batteries','chargeboards','backcover','housing','camera','flatcharging'];
  var typeLabels = {
    screens:'Ø´Ø§Ø´Ø©', batteries:'Ø¨Ø·Ø§Ø±ÙŠØ©', chargeboards:'Ø¨ÙˆØ±Ø¯ Ø´Ø­Ù†',
    backcover:'Ø¨Ø§Ùƒ ÙƒÙØ±', housing:'Ø´Ø§ØµÙŠ', camera:'ÙƒØ§Ù…ÙŠØ±Ø§', flatcharging:'Ø´Ø±ÙŠØ· Ø´Ø­Ù†'
  };

  var attempts = 0;
  function tryRender() {
    attempts++;
    var newItems = [];

    allTypes.forEach(function(t) {
      var data = getDataForType(t) || [];
      data.forEach(function(p, i) {
        var qty = Number(p.qty)||0;
        var price = Number(String(p.price||'').replace(/[^0-9]/g,''))||0;
        if (qty > 0 && price > 0 && isNewItem(p, t)) {
          newItems.push({p:p, type:t, label:typeLabels[t]||t, i:i, total:data.length});
        }
      });
    });

    // Keep trying if no data loaded yet
    if (!newItems.length) {
      // Check if data actually loaded at all
      var totalLoaded = allTypes.reduce(function(s,t){ return s+(getDataForType(t)||[]).length; },0);
      if (totalLoaded === 0 && attempts < 12) {
        setTimeout(tryRender, 500);
        return;
      }
    }

    // Save snapshot AFTER reading (next time, current items = old)
    saveSnapshotAfterLoad();

    // No new items
    if (!newItems.length) {
      body.innerHTML =
        '<div style="text-align:center;padding:40px 20px;">' +
          '<div style="font-size:48px;margin-bottom:12px;">ğŸ“¦</div>' +
          '<div style="font-size:17px;font-weight:700;color:#0F172A;margin-bottom:8px;">Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ø¬Ø¯ÙŠØ¯</div>' +
          '<div style="font-size:14px;color:#94A3B8;">Ø³ÙŠØ¸Ù‡Ø± Ù‡Ù†Ø§ Ø£ÙŠ Ù…Ù†ØªØ¬ Ø¬Ø¯ÙŠØ¯ ÙŠÙØ¶Ø§Ù Ù„Ù„Ù…Ø®Ø²ÙˆÙ†</div>' +
        '</div>';
      return;
    }

    // Sort: screens first, then newest first
    newItems.sort(function(a, b) {
      var aS = a.type === 'screens' ? 0 : 1;
      var bS = b.type === 'screens' ? 0 : 1;
      if (aS !== bS) return aS - bS;
      return (b.i / b.total) - (a.i / a.total);
    });

    var html = '<div style="font-size:13px;font-weight:700;color:#16A34A;margin-bottom:12px;padding:8px 12px;background:#DCFCE7;border-radius:10px;">âœ¨ ' + newItems.length + ' Ù…Ø§Ø¯Ø© Ø¬Ø¯ÙŠØ¯Ø©</div>';

    newItems.forEach(function(r) {
      var p = r.p;
      var price = Number(String(p.price||'').replace(/[^0-9]/g,''))||0;
      var pid = cacheProduct(Object.assign({}, p, {itemType: r.type}));
      html +=
        '<div class="price-item">' +
          '<span class="pi-type">' + r.label + '</span>' +
          '<div class="pi-name" style="margin-top:5px;">' + sanitize(p.name||'-') + '</div>' +
          '<div class="pi-brand">' + sanitize(p.brand||'-') + '</div>' +
          (p.type ? '<span class="pi-type" style="background:#F0FDF4;color:#15803D;margin-top:4px;display:inline-block;">' + sanitize(p.type) + '</span>' : '') +
          '<div class="pi-price avail" dir="ltr">' + formatPriceIQD(price) + ' IQD</div>' +
          (p.notes ? '<div class="pi-notes">ğŸ“ ' + sanitize(p.notes) + '</div>' : '') +
          '<button class="add-to-cart-btn" onclick="addToCart(getCachedProduct(\''+pid+'\'))">ğŸ›’ Ø¥Ø¶Ø§ÙØ© Ù„Ù„Ø³Ù„Ø©</button>' +
        '</div>';
    });
    body.innerHTML = html;
  }
  tryRender();
}

function openSearchSheet() {
  var u = JSON.parse(localStorage.getItem('amwaj_user')||'null');
  if (!u) { showScreen('loginScreen'); return; }
  openSheet('searchSheet');
  setTimeout(function() {
    var el = document.getElementById('globalSheetSearch');
    if (el) el.focus();
  }, 300);
}

function doGlobalSheetSearch() {
  var q = (document.getElementById('globalSheetSearch').value || '').trim().toLowerCase();
  var resultsDiv = document.getElementById('globalSheetResults');
  if (q.length < 2) {
    resultsDiv.innerHTML = '<div style="text-align:center;padding:30px;color:#94A3B8;font-size:14px;">Ø§ÙƒØªØ¨ Ø§Ø³Ù… Ø§Ù„Ù…Ù†ØªØ¬ Ù„Ù„Ø¨Ø­Ø«...</div>';
    return;
  }
  // Search all data types
  var allTypes = ['screens','batteries','chargeboards','flatcharging','backcover','housing','camera'];
  var flatSubs = ['FLAT POWER','FLAT VOLUME','BUZZER','EAR SPEAKER','DOOR SIM','FINGERPRINT','OTHER'];
  var results = [];
  allTypes.forEach(function(t) {
    var data = getDataForType(t);
    data.forEach(function(p) {
      if ((p.name||'').toLowerCase().includes(q) || (p.brand||'').toLowerCase().includes(q)) {
        results.push({p:p, type:t});
      }
    });
  });
  flatSubs.forEach(function(sub) {
    var data = getFlatSubData(sub);
    data.forEach(function(p) {
      if ((p.name||'').toLowerCase().includes(q) || (p.brand||'').toLowerCase().includes(q)) {
        results.push({p:p, type:'flatpower', sub:sub});
      }
    });
  });
  if (!results.length) {
    resultsDiv.innerHTML = '<div style="text-align:center;padding:30px;color:#94A3B8;">Ù„Ø§ ØªÙˆØ¬Ø¯ Ù†ØªØ§Ø¦Ø¬ Ù„Ù€ &quot;' + sanitize(q) + '&quot;</div>';
    return;
  }
  var oldSheetType = sheetPriceType;
  var html = '<div style="font-size:12px;color:#64748B;margin-bottom:8px;">' + Math.min(results.length,80) + ' Ù†ØªÙŠØ¬Ø©</div>';
  results.slice(0,80).forEach(function(r) {
    sheetPriceType = r.type;
    sheetFlatSubType = r.sub || null;
    html += createSheetPriceItem(r.p);
  });
  sheetPriceType = oldSheetType;
  resultsDiv.innerHTML = html;
}

// â”€â”€ New Arrivals â”€â”€
function loadNewItems() {
  var label = document.getElementById('newItemsLabel');
  var grid = document.getElementById('newItemsGrid');
  if (!label || !grid) return;

  label.style.display = 'flex';
  grid.style.display = 'block';
  grid.innerHTML = '<div style="text-align:center;padding:20px;"><div class="loading-spinner" style="margin:0 auto;width:28px;height:28px;"></div></div>';

  // Poll until data is loaded (max 5 seconds)
  var attempts = 0;
  function tryRender() {
    attempts++;
    var allTypes = ['screens','batteries','chargeboards','backcover','housing','camera','flatcharging'];
    var typeLabels = {
      screens:'Ø´Ø§Ø´Ø©', batteries:'Ø¨Ø·Ø§Ø±ÙŠØ©', chargeboards:'Ø¨ÙˆØ±Ø¯ Ø´Ø­Ù†',
      backcover:'Ø¨Ø§Ùƒ ÙƒÙØ±', housing:'Ø´Ø§ØµÙŠ', camera:'ÙƒØ§Ù…ÙŠØ±Ø§', flatcharging:'Ø´Ø±ÙŠØ· Ø´Ø­Ù†'
    };
    var newItems = [];

    allTypes.forEach(function(t) {
      var data = getDataForType(t) || [];
      var avail = data.filter(function(p) {
        var qty = Number(p.qty)||0;
        var price = Number(String(p.price||'').replace(/[^0-9]/g,''))||0;
        return qty > 0 && price > 0;
      });
      // Last 2 from each type = newest added in sheet
      avail.slice(-2).forEach(function(p) {
        newItems.push({p:p, type:t, label: typeLabels[t]||t});
      });
    });

    if (!newItems.length && attempts < 10) {
      setTimeout(tryRender, 600);
      return;
    }

    if (!newItems.length) {
      grid.innerHTML = '<div style="text-align:center;padding:24px;color:#94A3B8;">Ù„Ø§ ØªÙˆØ¬Ø¯ Ù…ÙˆØ§Ø¯ Ù…ØªÙˆÙØ±Ø© Ø­Ø§Ù„ÙŠØ§Ù‹</div>';
      return;
    }

    var html = '';
    newItems.forEach(function(r) {
      var p = r.p;
      var price = Number(String(p.price||'').replace(/[^0-9]/g,''))||0;
      var lbl = r.label;
      var t = r.type;
      var pid = 'nw_' + Math.random().toString(36).substr(2,8);
      window[pid] = p;
      window[pid].itemType = t;
      html +=
        '<div style="background:#fff;border:1px solid #E2E8F0;border-radius:14px;padding:12px 14px;margin-bottom:8px;display:flex;align-items:center;gap:12px;">' +
          '<div style="flex:1;min-width:0;">' +
            '<span style="font-size:10px;background:#EFF6FF;color:#0284C7;border-radius:6px;padding:2px 8px;font-weight:700;">' + lbl + '</span>' +
            '<div style="font-size:14px;font-weight:700;margin:5px 0 2px;color:#0F172A;">' + (p.name||'-') + '</div>' +
            '<div style="font-size:12px;color:#64748B;">' + (p.brand||'-') + '</div>' +
            '<div style="font-size:15px;font-weight:800;color:#0284C7;margin-top:4px;" dir="ltr">' + formatPriceIQD(price) + ' IQD</div>' +
          '</div>' +
          '<button onclick="addToCart(window[\'' + pid + '\'])" ' +
            'style="background:#16A34A;color:#fff;border:none;border-radius:10px;padding:10px 14px;font-size:18px;cursor:pointer;flex-shrink:0;width:auto;margin:0;line-height:1;">ğŸ›’</button>' +
        '</div>';
    });
    grid.innerHTML = html;
  }

  tryRender();
}

async function appBoot() {
  const phone = localStorage.getItem('amwaj_phone');
  
  // No phone saved â†’ register screen immediately
  if (!phone) { showScreen('registerScreen'); return; }

  // Cached approved user â†’ show home IMMEDIATELY, no loading
  const cachedUser = JSON.parse(localStorage.getItem('amwaj_user') || 'null');
  if (cachedUser && cachedUser.status === 'approved') {
    const welcome = document.getElementById('storeWelcome');
    if (welcome) welcome.textContent = 'Ø£Ù‡Ù„Ø§Ù‹ ' + cachedUser.name.split(' ')[0] + ' ğŸ‘‹';
    showScreen('homeScreen');
    // Background refresh
    setTimeout(async () => {
      try {
        const rows = await fetchCustomers();
        const user = rows.find(r => normalizePhone(r.phone) === phone);
        if (user) localStorage.setItem('amwaj_user', JSON.stringify(user));
        const ords = await secureApiCall('getMyOrders', { phone: cachedUser.phone });
        if (ords) { const ac = ords.filter(o => o.status === 'pending' || o.status === 'picked'); updateOrdersBadge(ac.length); }
      } catch(e) {}
    }, 1500);
    return;
  }

  // No cached user, phone exists â†’ show login immediately, fetch in background
  showScreen('loginScreen');
  setTimeout(async () => {
    try {
      const rows = await fetchCustomers();
      const user = rows.find(r => normalizePhone(r.phone) === phone);
      if (user && user.status === 'approved') {
        localStorage.setItem('amwaj_user', JSON.stringify(user));
        const welcome = document.getElementById('storeWelcome');
        if (welcome) welcome.textContent = 'Ø£Ù‡Ù„Ø§Ù‹ ' + user.name.split(' ')[0] + ' ğŸ‘‹';
        showScreen('homeScreen');
        try {
          const ords = await secureApiCall('getMyOrders', { phone: user.phone });
          if (ords) { const ac = ords.filter(o => o.status === 'pending' || o.status === 'picked'); updateOrdersBadge(ac.length); }
        } catch(e) {}
      } else if (user && user.status === 'pending') {
        document.getElementById('loginResult').innerHTML = '<div class="result pending">â³ Ø·Ù„Ø¨Ùƒ Ù‚ÙŠØ¯ Ø§Ù„Ù…Ø±Ø§Ø¬Ø¹Ø©ØŒ Ø§Ù†ØªØ¸Ø± Ù…ÙˆØ§ÙÙ‚Ø© Ø§Ù„Ø¥Ø¯Ø§Ø±Ø©</div>';
      }
    } catch(e) {}
  }, 500);
}

// Override submitRegistration to redirect to home
const _origSubmitReg = window.submitRegistration;
// Override checkLogin to use showScreen
const _origCheckLogin = window.checkLogin;



loadPrices(); loadBatteries(); loadChargeboards(); loadFlatMain();
loadBackCover(); loadHousing(); loadLens(); loadCamera();
loadBuzzer(); loadEarSpeaker(); loadDoorSim(); loadFingerprint(); loadMisc();
loadCart();
appBoot();
// Save snapshot after data loads
setTimeout(saveSnapshotAfterLoad, 4000);

if ('serviceWorker' in navigator) {
  window.addEventListener('load', () => {
    navigator.serviceWorker.register('/sw.js')
      .then(registration => console.log('âœ… PWA: Service Worker registered'))
      .catch(err => console.log('âŒ PWA: Service Worker registration failed', err));
  });
}

// renderAccountSheet â€” clean version
function renderAccountSheet() {
  const user = JSON.parse(localStorage.getItem('amwaj_user') || 'null');
  const div = document.getElementById('accountContent');
  if (!div) return;
  if (user) {
    div.innerHTML = [
      '<div style="background:linear-gradient(135deg,#0284C7,#0891B2);color:white;border-radius:16px;padding:20px;text-align:center;margin-bottom:16px;">',
        '<div style="font-size:40px;margin-bottom:8px;">ğŸ‘¤</div>',
        '<div style="font-size:18px;font-weight:800;">' + user.name + '</div>',
        '<div style="font-size:13px;opacity:.85;margin-top:4px;">' + user.shop + '</div>',
        '<div style="font-size:12px;opacity:.7;margin-top:2px;">' + user.phone + '</div>',
      '</div>',
      '<button class="form-btn" onclick="openWarrantyFromAccount()">âœ… ØªÙØ¹ÙŠÙ„ Ø§Ù„Ø¶Ù…Ø§Ù†</button>',
      '<button class="form-btn" style="background:#64748B;margin-top:8px;" onclick="openCheckFromAccount()">ğŸ” Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„Ø¶Ù…Ø§Ù†</button>',
      '<button class="form-btn danger" style="margin-top:12px;" onclick="logout()">ğŸšª ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø®Ø±ÙˆØ¬</button>',
    ].join('');
  } else {
    div.innerHTML = [
      '<div style="text-align:center;padding:20px 0;">',
        '<div style="font-size:48px;margin-bottom:12px;">ğŸ‘¤</div>',
        '<div style="font-size:16px;font-weight:700;margin-bottom:6px;">ØºÙŠØ± Ù…Ø³Ø¬Ù„ Ø§Ù„Ø¯Ø®ÙˆÙ„</div>',
        '<div style="font-size:13px;color:var(--muted);margin-bottom:20px;">Ø³Ø¬Ù„ Ø¯Ø®ÙˆÙ„Ùƒ Ù„Ù„ÙˆØµÙˆÙ„ Ù„ÙƒÙ„ Ø§Ù„Ø®Ø¯Ù…Ø§Øª</div>',
      '</div>',
      '<button class="form-btn" onclick="closeSheet(\'accountSheet\');showScreen(\'loginScreen\');">ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„</button>',
      '<button class="form-btn success-btn" style="margin-top:8px;" onclick="closeSheet(\'accountSheet\');showScreen(\'registerScreen\');">ØªØ³Ø¬ÙŠÙ„ Ø­Ø³Ø§Ø¨ Ø¬Ø¯ÙŠØ¯</button>',
    ].join('');
  }
}
function openWarrantyFromAccount() {
  closeSheet('accountSheet');
  openSheet('warrantySheet');
  const s = document.getElementById('start');
  if (s) s.value = formatDate(new Date());
}
function openCheckFromAccount() {
  closeSheet('accountSheet');
  openSheet('checkSheet');
}

</script>
</body>

</body>
</html>
