// استبدل دالة checkWarranty في الـ HTML بهذا الكود:

async function checkWarranty() {
  let v = normalizeNumber(document.getElementById("inv").value).trim().toUpperCase();
  let out = document.getElementById("out");
  
  if (!v) {
    alert("أدخل كود الشاشة");
    return;
  }

  out.innerHTML = '<div class="result pending">جاري البحث...</div>';

  try {
    const warranties = await secureApiCall('getWarranties');
    const r = warranties.find(w => normalizeNumber(String(w.screencode || "")).trim().toUpperCase() === v);

    if (r) {
      // قراءة تاريخ الانتهاء
      let endDate;
      if (r.end) {
        // إذا التاريخ string بصيغة DD/MM/YYYY
        if (typeof r.end === 'string' && r.end.includes('/')) {
          let [d, m, y] = r.end.split("/");
          endDate = new Date(y, m - 1, d);
        } 
        // إذا التاريخ رقم serial من Excel/Sheets
        else if (typeof r.end === 'number') {
          endDate = new Date((r.end - 25569) * 86400 * 1000);
        }
        // إذا التاريخ object
        else {
          endDate = new Date(r.end);
        }
      }
      
      // حساب الأيام المتبقية
      let remaining = endDate ? Math.ceil((endDate - new Date()) / (1000 * 60 * 60 * 24)) : null;
      let endDateStr = endDate ? formatDate(endDate) : (r.end || "-");
      
      out.innerHTML = `
        <div class="result ${remaining >= 0 ? 'success' : 'error'}">
          ${remaining >= 0 ? '✔️ الضمان موجود' : '❌ الضمان منتهي'}<br>
          الاسم: ${r.name || "-"}<br>
          الهاتف: ${r.phone || "-"}<br>
          اسم الشاشة: ${r.screenname || "-"}<br>
          النوع: ${r.type || "-"}<br>
          البدء: ${r.start || "-"}<br>
          الانتهاء: ${endDateStr}<br>
          ${remaining !== null ? (remaining >= 0 ? `⏳ المتبقي: <b>${remaining}</b> يوم` : `⏳ منتهي منذ <b>${Math.abs(remaining)}</b> يوم`) : ''}
        </div>
      `;
    } else {
      out.innerHTML = '<div class="result error">❌ لم يتم العثور على كود الشاشة</div>';
    }
  } catch (e) {
    console.error(e);
    out.innerHTML = '<div class="result error">❌ حدث خطأ: ' + e.message + '</div>';
  }
}
